---
phase: 02-session-detection
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/services/platform.ts
  - src/services/processDetector.ts
  - src/services/tmuxService.ts
autonomous: true

must_haves:
  truths:
    - "Platform detection correctly identifies linux, macos, or wsl2"
    - "Process detection finds Claude processes with PID, PPID, and elapsed time"
    - "Working directory can be retrieved for each detected process"
    - "tmux pane listing returns pane information when tmux is running"
    - "tmux correlation correctly identifies if a process is running in tmux"
  artifacts:
    - path: "src/services/platform.ts"
      provides: "Platform detection and cross-platform command execution"
      exports: ["detectPlatform", "getProcessCwd", "execAsync"]
    - path: "src/services/processDetector.ts"
      provides: "Claude process discovery"
      exports: ["findClaudeProcesses", "ClaudeProcess"]
    - path: "src/services/tmuxService.ts"
      provides: "tmux pane correlation"
      exports: ["getTmuxPanes", "isProcessInTmux", "getTmuxTarget", "TmuxPane"]
  key_links:
    - from: "src/services/processDetector.ts"
      to: "src/services/platform.ts"
      via: "import execAsync"
      pattern: "import.*execAsync.*from.*platform"
    - from: "src/services/tmuxService.ts"
      to: "src/services/platform.ts"
      via: "import execAsync"
      pattern: "import.*execAsync.*from.*platform"
---

<objective>
Create platform abstraction layer and process detection services for discovering Claude Code instances.

Purpose: Enable detection of all running Claude processes with their PIDs, working directories, elapsed time, and tmux association across Linux, macOS, and WSL2.

Output: Three service modules that handle cross-platform process detection and tmux correlation.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-session-detection/02-CONTEXT.md
@.planning/phases/02-session-detection/02-RESEARCH.md
@src/stores/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Platform Abstraction Layer</name>
  <files>src/services/platform.ts</files>
  <action>
Create platform detection and cross-platform command execution utilities:

1. `detectPlatform()`: Returns 'linux' | 'macos' | 'wsl2'
   - Check `process.platform` for darwin vs linux
   - For linux, check `os.release()` for "microsoft" or "wsl" to identify WSL2
   - Throw error for unsupported platforms

2. `execAsync`: Promisified exec with maxBuffer set to 5MB
   - Use `util.promisify(child_process.exec)`
   - Create wrapper that adds `{ maxBuffer: 5 * 1024 * 1024 }` option

3. `getProcessCwd(pid: number)`: Returns working directory for a process
   - Linux/WSL2: Use `readlink /proc/${pid}/cwd`
   - macOS: Use `lsof -p ${pid} | awk '/cwd/{ print $9 }'`
   - Return null if process doesn't exist or cwd can't be determined

Export Platform type and all functions. Use .js extension in any imports.
  </action>
  <verify>TypeScript compiles without errors: `npx tsc --noEmit`</verify>
  <done>platform.ts exports detectPlatform, execAsync, getProcessCwd with correct cross-platform logic</done>
</task>

<task type="auto">
  <name>Task 2: Process Detection Service</name>
  <files>src/services/processDetector.ts</files>
  <action>
Create Claude process discovery service:

1. Define `ClaudeProcess` interface:
   ```typescript
   interface ClaudeProcess {
     pid: number;
     ppid: number;
     elapsedSeconds: number;
     args: string;
   }
   ```

2. `findClaudeProcesses()`: Returns Promise<ClaudeProcess[]>
   - Execute: `ps -eo pid,ppid,etimes,args | grep -E "[c]laude "`
   - The `[c]` trick prevents grep from matching itself
   - Parse output with regex: `/^(\d+)\s+(\d+)\s+(\d+)\s+(.+)$/`
   - Filter to only processes where args contains "claude"
   - Return empty array on error (no processes found)
   - Use maxBuffer option via execAsync from platform.ts

Import execAsync from ./platform.js. Export ClaudeProcess type and findClaudeProcesses function.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>processDetector.ts exports findClaudeProcesses that parses ps output into ClaudeProcess objects</done>
</task>

<task type="auto">
  <name>Task 3: tmux Service</name>
  <files>src/services/tmuxService.ts</files>
  <action>
Create tmux pane correlation service:

1. Define `TmuxPane` interface:
   ```typescript
   interface TmuxPane {
     sessionName: string;
     windowIndex: number;
     paneIndex: number;
     panePid: number;
     target: string;  // "session:window.pane" format for tmux commands
   }
   ```

2. `getTmuxPanes()`: Returns Promise<TmuxPane[]>
   - Execute: `tmux list-panes -a -F "#{session_name}:#{window_index}.#{pane_index} #{pane_pid}"`
   - Parse output to build TmuxPane objects
   - target format: `${sessionName}:${windowIndex}.${paneIndex}`
   - Return empty array if tmux not running or command fails (catch errors)

3. `isProcessInTmux(ppid: number, panes: TmuxPane[])`: Returns tmux info or null
   - Check if ppid matches any pane's panePid
   - Return { inTmux: true, tmuxTarget: pane.target } if match found
   - Return { inTmux: false } if no match
   - Takes panes as parameter to avoid re-fetching (called once per refresh cycle)

4. `getTmuxTarget(ppid: number, panes: TmuxPane[])`: Returns string | undefined
   - Convenience function that returns just the tmux target string
   - Returns undefined if not in tmux

Import execAsync from ./platform.js. Export TmuxPane type and all functions.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>tmuxService.ts exports getTmuxPanes, isProcessInTmux, getTmuxTarget for tmux correlation</done>
</task>

</tasks>

<verification>
After all tasks:
1. `npx tsc --noEmit` passes with no errors
2. All three service files exist in src/services/
3. Each file exports the specified types and functions
4. Imports use .js extension for ESM compatibility
</verification>

<success_criteria>
- Platform detection works for linux, macos, wsl2
- Process detection can find Claude processes via ps command
- tmux service can list panes and correlate with process parent PIDs
- All code compiles with strict TypeScript
</success_criteria>

<output>
After completion, create `.planning/phases/02-session-detection/02-01-SUMMARY.md`
</output>
