---
phase: 09-pane-architecture
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - src/components/Tab.tsx
  - src/components/TabStrip.tsx
  - src/services/tmuxService.ts
  - src/app.tsx
autonomous: true

must_haves:
  truths:
    - "Active session has distinct visual marker separate from selection"
    - "Enter on a session switches main pane to that session"
    - "Ctrl+h returns focus to HUD pane from anywhere"
    - "Focus automatically moves to main pane after session switch"
  artifacts:
    - path: "src/components/Tab.tsx"
      provides: "isActive prop for active marker styling"
      contains: "isActive"
    - path: "src/app.tsx"
      provides: "Session switching on Enter key"
      contains: "switchToSession"
    - path: "src/services/tmuxService.ts"
      provides: "Ctrl+h keybinding setup"
      contains: "C-h"
  key_links:
    - from: "src/app.tsx"
      to: "src/services/paneSessionManager.ts"
      via: "import switchToSession"
      pattern: "import.*switchToSession.*from.*paneSessionManager"
    - from: "src/components/TabStrip.tsx"
      to: "src/stores/appStore.ts"
      via: "useAppStore activeSessionId"
      pattern: "activeSessionId"
---

<objective>
Wire up session switching and visual feedback for the pane architecture.

Purpose: Enable users to switch between sessions using Enter key and return to HUD with Ctrl+h, with clear visual indication of which session is active.
Output: Working session switching with active marker and return-to-HUD keybinding
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/09-pane-architecture/09-CONTEXT.md
@.planning/phases/09-pane-architecture/09-RESEARCH.md
@.planning/phases/09-pane-architecture/09-01-SUMMARY.md
@src/components/Tab.tsx
@src/components/TabStrip.tsx
@src/services/tmuxService.ts
@src/app.tsx
@src/stores/appStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add active marker to Tab component</name>
  <files>src/components/Tab.tsx, src/components/TabStrip.tsx</files>
  <action>
Update Tab component to show distinct active marker (what's in main pane) vs selection highlight (cursor position).

In Tab.tsx:

1. Add `isActive` prop to TabProps interface:
```typescript
interface TabProps {
  session: Session;
  index: number;
  isSelected: boolean;
  isActive: boolean;     // NEW: session is currently in main pane
  maxNameWidth?: number;
}
```

2. Update styling logic to handle three visual states:
   - Blocked: red background (highest priority, unchanged)
   - Active + Selected: inverse + underline
   - Active only: underline (shows "this is in main pane")
   - Selected only: inverse (shows "cursor is here")
   - Normal: default colors

3. Apply underline for active marker:
```typescript
// For active sessions, use underline to indicate "in main pane"
<Text underline>{content}</Text>
```

In TabStrip.tsx:

4. Get activeSessionId from store:
```typescript
const activeSessionId = useAppStore((state) => state.activeSessionId);
```

5. Pass isActive prop to Tab:
```typescript
<Tab
  key={session.id}
  session={session}
  index={displayIndex}
  isSelected={isSelected}
  isActive={session.id === activeSessionId}
  maxNameWidth={maxTabWidth}
/>
```
  </action>
  <verify>
TypeScript compiles: `npm run build`
Grep for isActive: `grep "isActive" src/components/Tab.tsx src/components/TabStrip.tsx`
  </verify>
  <done>
Tab component accepts isActive prop and applies underline styling. TabStrip passes activeSessionId comparison as isActive.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Ctrl+h keybinding for return-to-HUD</name>
  <files>src/services/tmuxService.ts</files>
  <action>
Update configureSession to add Ctrl+h keybinding for returning to HUD pane.

In tmuxService.ts configureSession function:

1. Add Ctrl+h binding alongside existing Ctrl+\ binding:
```typescript
const bindings = [
  // Ctrl+\\ to detach (keep session alive) - existing
  `bind-key -n C-\\\\ detach-client`,
  // Ctrl+h to focus HUD pane - NEW
  // Note: C-h may conflict with backspace in some terminals
  // Using stored HUD pane ID from environment
  `bind-key -n C-h select-pane -t #{CLAUDE_TERMINAL_HUD_PANE}`,
];
```

Note: The CLAUDE_TERMINAL_HUD_PANE environment variable is already set by createHudLayout() in Phase 7. The binding uses tmux's variable expansion to target the correct pane.

Alternative approach if environment variable doesn't work in bind-key:
```typescript
// Get HUD pane ID first, then bind
const hudPaneId = await execAsync(`tmux show-environment -g CLAUDE_TERMINAL_HUD_PANE`);
// Parse and use literal pane ID in binding
```
  </action>
  <verify>
TypeScript compiles: `npm run build`
Grep for C-h binding: `grep "C-h" src/services/tmuxService.ts`
  </verify>
  <done>
configureSession includes Ctrl+h binding that targets the HUD pane
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement Enter key session switching</name>
  <files>src/app.tsx</files>
  <action>
Update the Enter key handler to switch sessions using paneSessionManager.

1. Add imports at top of app.tsx:
```typescript
import { switchToSession, getActiveSessionId } from './services/paneSessionManager.js';
```

2. Replace the existing Enter key handler (around line 145-159) with pane-based switching:

```typescript
// Enter to switch to selected session in main pane
if (key.return) {
  const state = useAppStore.getState();
  const session = state.sessions[state.selectedIndex];
  if (session) {
    // Check if session is in tmux (can only switch to tmux sessions)
    if (!session.inTmux) {
      state.setError('Cannot switch to non-tmux session');
      setTimeout(() => {
        useAppStore.getState().setError(null);
      }, 3000);
      return;
    }

    // Get main pane ID from tmux environment
    // (stored by createHudLayout as the "other" pane)
    execAsync('tmux display-message -p "#{pane_id}"')
      .then(({ stdout: currentPane }) => {
        // Find main pane (not the HUD pane)
        return execAsync(`tmux show-environment CLAUDE_TERMINAL_HUD_PANE`)
          .then(({ stdout }) => {
            const hudPaneId = stdout.split('=')[1]?.trim();
            // Get all panes and find the main one (not HUD)
            return execAsync(`tmux list-panes -F '#{pane_id}'`)
              .then(({ stdout: paneList }) => {
                const panes = paneList.trim().split('\n');
                const mainPaneId = panes.find(p => p !== hudPaneId) || panes[1];
                return switchToSession(session.id, mainPaneId);
              });
          });
      })
      .then((result) => {
        if (result.success) {
          // Update active session in store
          useAppStore.getState().setActiveSessionId(session.id);
        } else {
          useAppStore.getState().setError(result.error || 'Failed to switch session');
          setTimeout(() => {
            useAppStore.getState().setError(null);
          }, 5000);
        }
      })
      .catch((err) => {
        useAppStore.getState().setError(`Switch failed: ${err.message}`);
        setTimeout(() => {
          useAppStore.getState().setError(null);
        }, 5000);
      });
  }
  return;
}
```

3. Add execAsync import if not present:
```typescript
import { execAsync } from './services/platform.js';
```

4. Remove the old jumpToSession import and related code since we're replacing that functionality with pane-based switching.

Note: The b key handler (returnToHud) can stay for now as a fallback, but Ctrl+h is the primary return mechanism.
  </action>
  <verify>
TypeScript compiles: `npm run build`
Grep for switchToSession: `grep "switchToSession" src/app.tsx`
  </verify>
  <done>
Enter key triggers pane-based session switching and updates activeSessionId in store
  </done>
</task>

</tasks>

<verification>
- [ ] `npm run build` succeeds with no TypeScript errors
- [ ] Tab component has isActive prop and underline styling
- [ ] TabStrip passes isActive based on activeSessionId
- [ ] tmuxService.ts has Ctrl+h binding
- [ ] app.tsx uses switchToSession on Enter key
- [ ] Smoke test: HUD starts without runtime errors
</verification>

<success_criteria>
All visual and interaction pieces are wired:
1. Tabs show underline for active session
2. Enter switches session and updates active marker
3. Ctrl+h binding is configured (may need runtime test)
</success_criteria>

<output>
After completion, create `.planning/phases/09-pane-architecture/09-02-SUMMARY.md`
</output>
