---
phase: 09-pane-architecture
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/services/paneSessionManager.ts
  - src/stores/types.ts
  - src/stores/appStore.ts
autonomous: true

must_haves:
  truths:
    - "Pane session manager can create panes in scratch window"
    - "Pane session manager can track session-to-pane mappings"
    - "AppStore has activeSessionId for tracking what's in main pane"
  artifacts:
    - path: "src/services/paneSessionManager.ts"
      provides: "Session pane lifecycle management"
      exports: ["ensureScratchWindow", "createSessionPane", "switchToSession", "getActiveSessionId"]
    - path: "src/stores/types.ts"
      provides: "activeSessionId type"
      contains: "activeSessionId"
    - path: "src/stores/appStore.ts"
      provides: "activeSessionId state and setter"
      contains: "setActiveSessionId"
  key_links:
    - from: "src/services/paneSessionManager.ts"
      to: "tmux set-environment"
      via: "execAsync"
      pattern: "set-environment CLAUDE_PANE"
---

<objective>
Create the pane session management foundation for multi-session switching.

Purpose: Enable the HUD to track which Claude session is displayed in the main pane and manage panes in a scratch window for hidden sessions.
Output: paneSessionManager.ts service + AppStore activeSessionId state
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/09-pane-architecture/09-CONTEXT.md
@.planning/phases/09-pane-architecture/09-RESEARCH.md
@src/services/tmuxService.ts
@src/stores/types.ts
@src/stores/appStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create paneSessionManager service</name>
  <files>src/services/paneSessionManager.ts</files>
  <action>
Create a new service for managing session panes with the scratch window pattern from RESEARCH.md.

Functions to implement:

1. `ensureScratchWindow(): Promise<string>` - Create/verify scratch window exists
   - Check if window named "scratch" exists in claude-terminal session
   - If not, create with `tmux new-window -d -t claude-terminal -n scratch`
   - Return the window target "claude-terminal:scratch"

2. `createSessionPane(sessionId: string, projectPath: string): Promise<string>` - Create pane for session
   - Split in scratch window: `tmux split-window -t ${scratchWindow} -P -F '#{pane_id}' -c "${projectPath}"`
   - Store mapping: `tmux set-environment CLAUDE_PANE_${sessionId} ${paneId}`
   - Return the pane ID

3. `getSessionPane(sessionId: string): Promise<string | null>` - Get pane ID for session
   - Query: `tmux show-environment CLAUDE_PANE_${sessionId}`
   - Parse output format "CLAUDE_PANE_xxx=%NN" to extract pane ID
   - Return null if not found

4. `switchToSession(sessionId: string, mainPaneId: string): Promise<{success: boolean; error?: string}>` - Swap session into main pane
   - Get target pane ID from environment
   - Execute: `tmux swap-pane -s ${targetPaneId} -t ${mainPaneId}`
   - Update tracking: `tmux set-environment CLAUDE_ACTIVE_SESSION ${sessionId}`
   - Focus main pane: `tmux select-pane -t ${mainPaneId}`

5. `getActiveSessionId(): Promise<string | null>` - Get currently active session
   - Query: `tmux show-environment CLAUDE_ACTIVE_SESSION`
   - Parse and return session ID or null

Use execAsync from platform.js (existing pattern). Handle errors gracefully with try/catch.
  </action>
  <verify>
TypeScript compiles: `npm run build`
Grep for exports: `grep -E "export (async )?function" src/services/paneSessionManager.ts`
  </verify>
  <done>
paneSessionManager.ts exists with all 5 functions exported and TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend AppStore with activeSessionId</name>
  <files>src/stores/types.ts, src/stores/appStore.ts</files>
  <action>
Add activeSessionId to track which session is currently displayed in the main pane.

In types.ts, add to AppState interface:
```typescript
// In AppState interface
activeSessionId: string | null;  // Session currently displayed in main pane

// In actions
setActiveSessionId: (id: string | null) => void;
```

In appStore.ts, add:
```typescript
// Initial state
activeSessionId: null,

// Action
setActiveSessionId: (id) => set({ activeSessionId: id }),
```

This is distinct from selectedIndex:
- selectedIndex: Which tab the user is highlighting/browsing
- activeSessionId: Which session is actually showing in the main pane
  </action>
  <verify>
TypeScript compiles: `npm run build`
Grep for activeSessionId: `grep "activeSessionId" src/stores/types.ts src/stores/appStore.ts`
  </verify>
  <done>
activeSessionId and setActiveSessionId exist in both types.ts and appStore.ts
  </done>
</task>

</tasks>

<verification>
- [ ] `npm run build` succeeds with no TypeScript errors
- [ ] paneSessionManager.ts has 5 exported functions
- [ ] appStore has activeSessionId state and setter
- [ ] No runtime errors when HUD starts (smoke test)
</verification>

<success_criteria>
Foundation services exist for pane management and active session tracking. TypeScript compiles cleanly. No changes to visual behavior yet (this plan creates infrastructure only).
</success_criteria>

<output>
After completion, create `.planning/phases/09-pane-architecture/09-01-SUMMARY.md`
</output>
