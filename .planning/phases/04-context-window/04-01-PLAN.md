---
phase: 04-context-window
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/services/contextService.ts
  - src/services/hookStateService.ts
  - src/stores/types.ts
autonomous: true

must_haves:
  truths:
    - "Context usage percentage can be calculated from JSONL transcript"
    - "Context percentage is available during session refresh cycle"
    - "Missing or stale transcripts return null gracefully"
  artifacts:
    - path: "src/services/contextService.ts"
      provides: "JSONL parsing and percentage calculation"
      exports: ["getContextUsage"]
    - path: "src/services/hookStateService.ts"
      provides: "Extended to include transcriptPath"
      contains: "transcriptPath"
  key_links:
    - from: "src/services/contextService.ts"
      to: "JSONL transcript file"
      via: "fs.readFileSync reverse parsing"
      pattern: "readFileSync.*jsonl"
    - from: "src/services/contextService.ts"
      to: "hookStateService"
      via: "getContextUsage uses transcriptPath"
      pattern: "transcriptPath"
---

<objective>
Create the context service that parses Claude Code JSONL transcripts to extract token usage and calculate context window percentage.

Purpose: Enable the HUD to display context window usage by extracting cumulative token usage from transcript files.
Output: contextService.ts with getContextUsage function, hookStateService extended with transcriptPath support.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-context-window/04-RESEARCH.md

# Existing code to understand patterns
@src/services/hookStateService.ts
@src/services/sessionBuilder.ts
@src/hooks/status-hook.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend hook state to include transcript path</name>
  <files>
    src/services/hookStateService.ts
    src/hooks/status-hook.sh
  </files>
  <action>
1. Update HookSessionState interface in hookStateService.ts to add:
   - `transcriptPath: string | null` field

2. Update readSessionState and findStateByPath to read transcriptPath from state files.

3. Update getHookBasedStatus to return transcriptPath along with status, model, subagentCount, and notification. Update the return type to include `transcriptPath: string | null` and ensure all callers receive it.

4. Update status-hook.sh to write transcriptPath to the state file:
   - The hook already receives transcript_path in the input JSON ($TRANSCRIPT_PATH variable)
   - Add it to the JSON output in the heredoc

Note: The bash hook already parses TRANSCRIPT_PATH from input - just need to include it in the JSON output.
  </action>
  <verify>
    Run HUD with `npm run dev`, verify no TypeScript errors. Check ~/.claude-hud/sessions/*.json files include transcriptPath field after a Claude session sends a hook event.
  </verify>
  <done>
    Hook state files contain transcriptPath field, and hookStateService reads and returns it.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create context service for JSONL parsing</name>
  <files>
    src/services/contextService.ts
  </files>
  <action>
Create contextService.ts with the following implementation:

1. Define constants:
   - CONTEXT_WINDOW_SIZE = 200_000 (all Claude 4.x models use 200K standard)

2. Define interface for JSONL assistant entry (from research):
```typescript
interface AssistantEntry {
  type: 'assistant';
  isSidechain?: boolean;
  isApiErrorMessage?: boolean;
  message?: {
    usage?: {
      input_tokens: number;
      cache_creation_input_tokens: number;
      cache_read_input_tokens: number;
      output_tokens: number;
    };
  };
  timestamp?: string;
}
```

3. Implement getContextUsage(transcriptPath: string | null): number | null
   - Return null if transcriptPath is null or file doesn't exist
   - Read file from END (performance: read last ~50KB, not entire 10-20MB file)
   - Parse lines as JSON, filter for:
     - type === 'assistant'
     - NOT isSidechain
     - NOT isApiErrorMessage
     - Has message.usage object
   - Get the LAST valid entry (most recent by position, not timestamp)
   - Calculate total tokens: input_tokens + cache_creation_input_tokens + cache_read_input_tokens
   - Calculate percentage: (totalTokens / CONTEXT_WINDOW_SIZE) * 100
   - Return rounded percentage (0-100), capped at 100
   - Return null on any parsing error (graceful degradation)

4. Use synchronous file reading (same pattern as hookStateService) for simplicity.

Performance considerations:
- Only read last 50KB of file (tail approach) - most recent messages are at end
- Cache result with file mtime check to avoid re-parsing unchanged files
- Use a simple Map<string, {mtime: number, percentage: number}> cache
  </action>
  <verify>
    TypeScript compiles without errors. Manually test by:
    1. Run a Claude session to generate transcript
    2. Import and call getContextUsage with the transcript path
    3. Verify it returns a number between 0-100
  </verify>
  <done>
    getContextUsage function parses JSONL transcripts and returns context percentage, with null for missing/invalid data.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate context service into session builder</name>
  <files>
    src/services/sessionBuilder.ts
  </files>
  <action>
Update sessionBuilder.ts to populate contextUsage field:

1. Import getContextUsage from contextService.ts

2. In buildSessions function, after getting hook-based status:
   - Get transcriptPath from hook state (add to getHookBasedStatus return)
   - Call getContextUsage(transcriptPath)
   - Use result or 0 if null

3. Update the Session object construction to use calculated contextUsage instead of hardcoded 0.

Note: The Session type already has contextUsage: number field (from Phase 1 types).
  </action>
  <verify>
    Run HUD with `npm run dev`. Sessions should now have contextUsage populated (may show 0 initially if no transcript exists yet). No TypeScript errors.
  </verify>
  <done>
    Each session's contextUsage field is populated from JSONL transcript parsing during the refresh cycle.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds with no TypeScript errors
2. `npm run dev` starts HUD without crashes
3. Hook state files in ~/.claude-hud/sessions/ include transcriptPath
4. Console log or debug shows contextUsage values being calculated
5. Sessions with active transcripts show non-zero contextUsage
</verification>

<success_criteria>
- contextService.ts exists and exports getContextUsage function
- hookStateService includes transcriptPath in state reading
- sessionBuilder populates contextUsage from transcript parsing
- Graceful handling: null/missing transcripts result in 0 or null, no crashes
- Performance: Reading transcripts doesn't noticeably slow refresh cycle
</success_criteria>

<output>
After completion, create `.planning/phases/04-context-window/04-01-SUMMARY.md`
</output>
