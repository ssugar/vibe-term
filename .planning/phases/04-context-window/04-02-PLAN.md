---
phase: 04-context-window
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/components/ContextMeter.tsx
  - src/components/SessionRow.tsx
autonomous: false

must_haves:
  truths:
    - "Each session row displays context usage as a visual progress bar"
    - "Progress bar is green when usage is below 30%"
    - "Progress bar is yellow when usage is 30-70%"
    - "Progress bar is red when usage exceeds 70%"
    - "Percentage text is displayed next to the bar"
  artifacts:
    - path: "src/components/ContextMeter.tsx"
      provides: "Progress bar component with stoplight colors"
      exports: ["ContextMeter"]
      min_lines: 30
    - path: "src/components/SessionRow.tsx"
      provides: "Session row with integrated context meter"
      contains: "ContextMeter"
  key_links:
    - from: "src/components/SessionRow.tsx"
      to: "src/components/ContextMeter.tsx"
      via: "import and render"
      pattern: "import.*ContextMeter"
    - from: "src/components/ContextMeter.tsx"
      to: "session.contextUsage"
      via: "percent prop"
      pattern: "percent.*number"
---

<objective>
Create the ContextMeter UI component and integrate it into SessionRow to display context window usage with stoplight colors.

Purpose: Give users instant visual feedback on context consumption for each Claude session.
Output: ContextMeter.tsx component with progress bar, SessionRow.tsx updated to display context usage.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-context-window/04-RESEARCH.md
@.planning/phases/04-context-window/04-01-SUMMARY.md

# Existing UI components for pattern reference
@src/components/SessionRow.tsx
@src/components/Header.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ContextMeter component</name>
  <files>
    src/components/ContextMeter.tsx
  </files>
  <action>
Create ContextMeter.tsx with the following implementation:

1. Props interface:
```typescript
interface ContextMeterProps {
  percent: number;      // 0-100
  width?: number;       // Bar width in characters, default 12
  showPercent?: boolean; // Whether to show percentage text, default true
}
```

2. Stoplight color function:
```typescript
function getStoplightColor(percent: number): 'green' | 'yellow' | 'red' {
  if (percent < 30) return 'green';
  if (percent < 70) return 'yellow';
  return 'red';
}
```

3. Unicode block progress bar rendering:
   - Use full block U+2588 (█) for filled portion
   - Use light shade U+2591 (░) for empty portion
   - Calculate filled chars: Math.round((percent / 100) * width)
   - Build string: '█'.repeat(filled) + '░'.repeat(width - filled)

4. Component structure:
```tsx
export function ContextMeter({ percent, width = 12, showPercent = true }: ContextMeterProps) {
  const color = getStoplightColor(percent);
  const bar = renderProgressBar(percent, width);
  const percentText = `${Math.round(percent)}%`;

  return (
    <Box>
      <Text color={color}>{bar}</Text>
      {showPercent && <Text color={color}> {percentText.padStart(4)}</Text>}
    </Box>
  );
}
```

5. Handle edge cases:
   - percent < 0: treat as 0
   - percent > 100: treat as 100
   - Add warning indicator at 90%+: prefix bar with "!" in red

6. Import Box and Text from 'ink'.
  </action>
  <verify>
    TypeScript compiles without errors. Component can be imported and rendered with test values.
  </verify>
  <done>
    ContextMeter component renders a colored progress bar with percentage text, colors match thresholds.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate ContextMeter into SessionRow</name>
  <files>
    src/components/SessionRow.tsx
  </files>
  <action>
Update SessionRow.tsx to include the ContextMeter:

1. Import ContextMeter from './ContextMeter.js'

2. Add ContextMeter to the row layout AFTER the model display:
   - Position: End of row (Index | Status | Project | Duration | Model | Subagent | Context | Tmux)
   - Use session.contextUsage as the percent prop

3. Update blocked row styling to include context meter:
   - For blocked rows, include context meter outside the red background section
   - This maintains the red emphasis on blocked status while showing context

4. Layout update for normal row (add after model section):
```tsx
{/* Context meter */}
<ContextMeter percent={session.contextUsage} width={12} />
<Text> </Text>
```

5. Ensure proper spacing:
   - Add space separator before ContextMeter
   - Keep existing spacing for tmux indicator after

6. Handle null/undefined contextUsage:
   - If contextUsage is falsy (0, null, undefined), still show meter at 0%
   - This provides consistent visual layout across all rows
  </action>
  <verify>
    Run `npm run dev`, verify sessions display context meter after model name. Colors should vary based on percentage value.
  </verify>
  <done>
    SessionRow displays ContextMeter for each session, colors match the stoplight thresholds.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Context window display with stoplight color coding:
    - Progress bar showing context usage percentage
    - Green color for usage below 30%
    - Yellow color for usage 30-70%
    - Red color for usage above 70%
    - Warning indicator at 90%+
  </what-built>
  <how-to-verify>
    1. Start the HUD: `npm run dev`
    2. Have at least one Claude session running with some context usage
    3. Verify each session row shows a context meter (progress bar + percentage)
    4. Verify the color matches the usage level:
       - Low usage sessions (if any): green bar
       - Medium usage: yellow bar
       - High usage: red bar
    5. Verify the progress bar length corresponds to the percentage shown
    6. If a session has very high usage (90%+), verify warning indicator appears
    7. Blocked sessions still show red background AND context meter is visible
  </how-to-verify>
  <resume-signal>Type "approved" if context display works correctly, or describe any visual issues</resume-signal>
</task>

</tasks>

<verification>
1. `npm run build` succeeds with no TypeScript errors
2. `npm run dev` shows context meters on all session rows
3. Colors match thresholds: green <30%, yellow 30-70%, red >70%
4. Progress bar accurately reflects percentage value
5. Layout is clean with proper spacing between elements
6. Blocked rows maintain emphasis while showing context
</verification>

<success_criteria>
- ContextMeter.tsx exists and renders colored progress bars
- SessionRow.tsx imports and displays ContextMeter
- Visual stoplight colors work: green/yellow/red based on percentage
- Human verification confirms the display is clear and useful
- Layout integrates smoothly with existing row elements
</success_criteria>

<output>
After completion, create `.planning/phases/04-context-window/04-02-SUMMARY.md`
</output>
