---
phase: 10-session-lifecycle
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/services/directoryService.ts
  - src/app.tsx
  - src/components/HudStrip.tsx
autonomous: true

must_haves:
  truths:
    - "User can press n to enter spawn mode"
    - "Tab key cycles through directory completions"
    - "If directory doesn't exist, user is prompted to create it"
    - "Enter spawns session in specified directory"
    - "Escape cancels spawn mode"
  artifacts:
    - path: "src/services/directoryService.ts"
      provides: "Directory completion and validation"
      exports: ["getDirectoryCompletions", "expandTilde", "directoryExists", "createDirectory"]
    - path: "src/app.tsx"
      provides: "Enhanced spawn mode with tab completion"
      contains: "completionState"
  key_links:
    - from: "src/app.tsx"
      to: "src/services/directoryService.ts"
      via: "import getDirectoryCompletions"
      pattern: "getDirectoryCompletions"
---

<objective>
Implement directory tab completion and enhanced spawn flow for new Claude sessions.

Purpose: Enable users to quickly spawn new Claude sessions with full directory tab completion and validation. When a directory doesn't exist, prompt to create it rather than failing silently.

Output: New directoryService.ts with completion logic, enhanced spawn mode in app.tsx with Tab cycling and mkdir prompt.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-session-lifecycle/10-RESEARCH.md
@src/app.tsx
@src/services/paneSessionManager.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create directory service</name>
  <files>src/services/directoryService.ts</files>
  <action>
Create new service with four exported functions:

1. `expandTilde(path: string): string` - Expand ~ to process.env.HOME
2. `directoryExists(path: string): boolean` - Check if expanded path exists and is directory
3. `createDirectory(path: string): void` - Create directory with recursive: true (mkdir -p)
4. `getDirectoryCompletions(partial: string): string[]` - Return matching directories

For getDirectoryCompletions:
- Expand tilde first
- Use path.dirname() to get search directory, path.basename() for prefix
- Use fs.readdirSync with withFileTypes: true option
- Filter for isDirectory() and startsWith(prefix)
- Return full paths (join searchDir + entry.name)
- Handle edge cases: empty input (return []), invalid path (return [])
- Wrap in try/catch, return empty array on error

Import from 'fs' (existsSync, readdirSync, mkdirSync, statSync) and 'path' (dirname, basename, join).
Use .js extension for ESM imports.
  </action>
  <verify>
Create test file manually and verify:
- expandTilde('~/test') returns /home/USER/test
- directoryExists('/tmp') returns true
- directoryExists('/nonexistent-path-xyz') returns false
- getDirectoryCompletions('/ho') returns ['/home'] (or similar)
  </verify>
  <done>
directoryService.ts exports all four functions, handles edge cases gracefully, uses proper ESM imports.
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhance spawn mode with tab completion and mkdir prompt</name>
  <files>src/app.tsx</files>
  <action>
Enhance existing spawn mode (lines 110-186) with full tab completion:

1. Add state for completion tracking:
   - completions: string[] (matching directories)
   - completionIndex: number (current selection)
   - showMkdirPrompt: boolean (whether showing create directory prompt)

2. Modify Tab key handler (line 174):
   - On first Tab press: call getDirectoryCompletions(spawnInput), store in completions
   - If completions exist: replace spawnInput with completions[completionIndex]
   - On subsequent Tab presses: increment completionIndex (wrap around), update spawnInput
   - Reset completionIndex to 0 when user types new characters

3. Modify Enter key handler (line 120):
   - Before spawning, check directoryExists(expandedPath)
   - If exists: proceed with spawn (existing logic)
   - If not exists: set showMkdirPrompt = true, wait for user response

4. Add mkdir prompt handling:
   - When showMkdirPrompt is true, check for y/n input
   - 'y': call createDirectory(expandedPath), then proceed with spawn
   - 'n' or Escape: cancel, clear showMkdirPrompt and spawnMode

5. Update HudStrip call to pass new props (showMkdirPrompt, or encode in spawnMode state)

6. Modify character input handler (line 182):
   - After adding character, reset completions to [] and completionIndex to 0

Import from directoryService.ts at top of file.
  </action>
  <verify>
npm run build succeeds. Manual test:
1. Press n to enter spawn mode
2. Type "/ho" then Tab - should complete to "/home"
3. Press Tab again - should cycle to next match if any
4. Type "/nonexistent" then Enter - should show mkdir prompt
5. Press y - directory created and Claude spawns
6. Press Escape at any point - cancels spawn mode
7. Spawned session appears in main pane (not scratch) - confirms SESS-02
  </verify>
  <done>
Tab completion cycles through matches, mkdir prompt appears for non-existent directories, y creates and spawns, n cancels. Spawned session appears in main pane.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update HudStrip for mkdir prompt display</name>
  <files>src/components/HudStrip.tsx</files>
  <action>
Add mkdir prompt display to HudStrip component:

1. Add prop: `showMkdirPrompt?: boolean` (or pass mkdirPath?: string)

2. Update priority logic (line 29-33) to include mkdir prompt:
   - showMkdirPrompt should take precedence over showSpawnPrompt when active

3. Add mkdir prompt JSX (after spawn prompt, similar pattern):
   ```tsx
   {showMkdirPrompt && (
     <Text>
       <Text color="yellow">Directory doesn't exist. Create it? </Text>
       <Text bold color="green">[y]</Text>
       <Text>es / </Text>
       <Text bold color="red">[n]</Text>
       <Text>o</Text>
     </Text>
   )}
   ```

4. Update spawn prompt to show completion hint when Tab has been pressed:
   - Pass completionCount prop from app.tsx
   - If completionCount > 0, show "(Tab: n matches)" in dimColor
  </action>
  <verify>
npm run build succeeds. Visual inspection: mkdir prompt appears below tabs when triggered.
  </verify>
  <done>
HudStrip shows mkdir prompt when directory doesn't exist, styled consistently with other prompts.
  </done>
</task>

</tasks>

<verification>
- [ ] directoryService.ts exists with all four exports
- [ ] npm run build completes without errors
- [ ] Tab completion works in spawn mode (cycles through matches)
- [ ] Non-existent directory shows mkdir prompt
- [ ] 'y' creates directory and spawns session
- [ ] 'n' or Escape cancels without creating
- [ ] Existing directory spawns immediately (no prompt)
</verification>

<success_criteria>
1. Spawn mode has full tab completion that cycles through matches
2. Directory validation prevents spawning in non-existent directories unless user confirms creation
3. All edge cases handled gracefully (empty input, invalid paths, permissions errors)
</success_criteria>

<output>
After completion, create `.planning/phases/10-session-lifecycle/10-01-SUMMARY.md`
</output>
