---
phase: 10-session-lifecycle
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/stores/types.ts
  - src/services/sessionBuilder.ts
  - src/components/TabStrip.tsx
  - src/components/Tab.tsx
autonomous: true

must_haves:
  truths:
    - "External sessions (Claude in other tmux sessions) appear in HUD"
    - "Managed and external sessions are visually distinguished"
    - "External sessions display on right side with divider"
    - "Enter on external session switches to it (select-pane, not swap-pane)"
  artifacts:
    - path: "src/stores/types.ts"
      provides: "Session interface with isExternal field"
      contains: "isExternal: boolean"
    - path: "src/services/sessionBuilder.ts"
      provides: "Session classification logic"
      contains: "isExternal"
    - path: "src/components/TabStrip.tsx"
      provides: "Divided tab display"
      contains: "externalWithIndices"
  key_links:
    - from: "src/components/TabStrip.tsx"
      to: "src/stores/types.ts"
      via: "Session.isExternal"
      pattern: "session\\.isExternal"
    - from: "src/services/sessionBuilder.ts"
      to: "src/startup.ts"
      via: "TMUX_SESSION_NAME import"
      pattern: "TMUX_SESSION_NAME"
---

<objective>
Add external session detection and display with visual distinction from managed sessions.

Purpose: Users running Claude in other tmux sessions should see those sessions in the HUD, but clearly distinguished from sessions spawned by claude-terminal. This enables monitoring all Claude instances from a single HUD.

Output: isExternal field on Session type, classification logic in sessionBuilder, divided display in TabStrip.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-session-lifecycle/10-RESEARCH.md
@src/stores/types.ts
@src/services/sessionBuilder.ts
@src/components/TabStrip.tsx
@src/components/Tab.tsx
@src/startup.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add isExternal field to Session type</name>
  <files>src/stores/types.ts</files>
  <action>
Add isExternal field to Session interface (after paneId line 16):

```typescript
isExternal: boolean;   // true if running in non-claude-terminal tmux session
```

This field indicates sessions discovered in other tmux sessions, not spawned by claude-terminal.
External sessions:
- Are detected via process detection (same as managed)
- Have tmuxTarget pointing to different tmux session
- Cannot use swap-pane (must use select-pane to switch)
- Should be displayed separately with visual distinction
  </action>
  <verify>
npm run build - TypeScript should compile (will have errors until sessionBuilder is updated)
  </verify>
  <done>
Session interface includes isExternal: boolean field with documentation comment.
  </done>
</task>

<task type="auto">
  <name>Task 2: Classify sessions as managed vs external in sessionBuilder</name>
  <files>src/services/sessionBuilder.ts</files>
  <action>
Update buildSessions to classify each session:

1. Import TMUX_SESSION_NAME from '../startup.js' at top of file

2. In the session building map (line 159), after setting paneId, add classification:
   ```typescript
   // Classify as external if tmux target doesn't start with our session name
   const isExternal = tmuxInfo.inTmux &&
     (!tmuxInfo.tmuxTarget?.startsWith(`${TMUX_SESSION_NAME}:`));
   ```

3. Add isExternal to the returned Session object:
   ```typescript
   return {
     id: `claude-${process.pid}`,
     // ... existing fields ...
     isExternal,
   };
   ```

Note: A session is external if:
- It IS in tmux (inTmux: true)
- Its tmuxTarget does NOT start with "claude-terminal:"

Sessions NOT in tmux are not external (they're standalone terminal sessions, handled differently).
  </action>
  <verify>
npm run build succeeds. With a Claude running in a different tmux session, HUD should still detect it (existing behavior continues to work).
  </verify>
  <done>
sessionBuilder correctly classifies sessions, isExternal is true only for Claude in other tmux sessions.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update TabStrip to display managed and external sessions separately</name>
  <files>src/components/TabStrip.tsx</files>
  <action>
Modify TabStrip to show three groups: blocked, managed (non-blocked internal), external.

1. Update the session categorization useMemo (line 64-78):
   ```typescript
   const { blockedWithIndices, managedWithIndices, externalWithIndices } = useMemo(() => {
     const blocked: Array<{ session: Session; originalIndex: number }> = [];
     const managed: Array<{ session: Session; originalIndex: number }> = [];
     const external: Array<{ session: Session; originalIndex: number }> = [];

     sessions.forEach((session, idx) => {
       const item = { session, originalIndex: idx + 1 };
       if (session.status === 'blocked') {
         blocked.push(item);
       } else if (session.isExternal) {
         external.push(item);
       } else {
         managed.push(item);
       }
     });

     return { blockedWithIndices: blocked, managedWithIndices: managed, externalWithIndices: external };
   }, [sessions]);
   ```

2. Update layout metrics calculation to account for divider and external tabs:
   - Add divider width (3 chars: " | ")
   - External tabs are shown after divider, right side

3. Update the scroll logic to only scroll managed sessions (external stays fixed on right)

4. Update the render to show:
   - Left arrow (if scrolled)
   - Blocked tabs (pinned left)
   - Managed tabs (scrollable middle)
   - Divider (if external sessions exist): " | " with dimColor
   - External tabs (pinned right)
   - Right arrow (if more managed tabs)

5. Add divider JSX:
   ```tsx
   {externalWithIndices.length > 0 && (
     <Text dimColor> | </Text>
   )}
   ```
  </action>
  <verify>
npm run build succeeds. With sessions in both claude-terminal and external tmux:
- Managed sessions appear on left
- Divider "|" appears
- External sessions appear on right with distinct styling
  </verify>
  <done>
TabStrip displays managed and external sessions separately with visual divider.
  </done>
</task>

</tasks>

<verification>
- [ ] npm run build completes without errors
- [ ] Session type includes isExternal field
- [ ] sessionBuilder correctly identifies external sessions
- [ ] TabStrip shows divider when external sessions exist
- [ ] Managed sessions scrollable, external sessions pinned right
- [ ] Enter on external session uses select-pane (existing behavior in app.tsx line 275)
</verification>

<success_criteria>
1. Sessions in other tmux sessions are detected and displayed
2. Clear visual distinction between managed (claude-terminal) and external sessions
3. External sessions pinned to right side with divider separator
</success_criteria>

<output>
After completion, create `.planning/phases/10-session-lifecycle/10-02-SUMMARY.md`
</output>
