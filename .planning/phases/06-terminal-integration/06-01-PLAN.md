---
phase: 06-terminal-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/services/windowFocusService.ts
  - src/services/jumpService.ts
autonomous: true

must_haves:
  truths:
    - "Pressing Enter on a non-tmux session attempts to focus terminal window"
    - "Platform-specific focus uses appropriate CLI tool (xdotool/osascript/powershell)"
    - "Graceful error with installation hint when focus tool unavailable"
    - "Wayland detected with appropriate error message"
  artifacts:
    - path: "src/services/windowFocusService.ts"
      provides: "Cross-platform terminal window focus"
      exports: ["focusTerminalWindow", "FocusResult"]
    - path: "src/services/jumpService.ts"
      provides: "Session jumping (tmux + non-tmux)"
      exports: ["jumpToSession", "JumpResult"]
  key_links:
    - from: "src/services/jumpService.ts"
      to: "src/services/windowFocusService.ts"
      via: "focusTerminalWindow call for non-tmux sessions"
      pattern: "focusTerminalWindow"
    - from: "src/services/windowFocusService.ts"
      to: "xdotool/osascript/powershell.exe"
      via: "execAsync shell commands"
      pattern: "execAsync\\("
---

<objective>
Create cross-platform terminal window focus service and integrate it with jumpService for non-tmux sessions.

Purpose: Enable jumping to Claude sessions running in regular terminal windows (not tmux) across Linux, macOS, and WSL2.
Output: windowFocusService.ts with platform-specific implementations, updated jumpService.ts that uses it.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-terminal-integration/06-RESEARCH.md

# Existing code to extend
@src/services/platform.ts
@src/services/jumpService.ts
@src/stores/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create windowFocusService with platform-specific implementations</name>
  <files>src/services/windowFocusService.ts</files>
  <action>
Create windowFocusService.ts with:

1. **FocusResult interface** (already defined in research):
   ```typescript
   export interface FocusResult {
     success: boolean;
     message: string;
     hint?: string;  // Installation hint on failure
   }
   ```

2. **Wayland detection** (check WAYLAND_DISPLAY and XDG_SESSION_TYPE):
   ```typescript
   function isWayland(): boolean {
     return (
       !!process.env.WAYLAND_DISPLAY ||
       process.env.XDG_SESSION_TYPE === 'wayland'
     );
   }
   ```

3. **Runtime dependency detection** (hasCommand using `which`):
   - Check for xdotool on Linux
   - osascript is built-in on macOS
   - powershell.exe is built-in on WSL2

4. **Platform-specific focus functions**:
   - `focusLinuxWindow(session)`:
     - Check for Wayland first, return error with hint
     - Check for xdotool, return install hint if missing
     - Try PID-based search: `xdotool search --pid <terminalPid> windowactivate`
     - Fall back to title matching: `xdotool search --name "<projectName>" windowactivate`

   - `focusMacWindow(session)`:
     - Use osascript to activate Terminal.app
     - Document limitation: focuses app, not specific tab

   - `focusWsl2Window(session)`:
     - PowerShell script to focus Windows Terminal using SetForegroundWindow API
     - Include ShowWindowAsync with SW_RESTORE (9) before SetForegroundWindow
     - Timeout of 5 seconds

5. **findTerminalPid helper**:
   - Walk up process tree from Claude PID
   - Use existing getProcessCwd pattern from platform.ts
   - Check process name against known terminals (gnome-terminal, xterm, konsole, alacritty, kitty, terminator, tilix, urxvt, st)
   - Max depth of 10 to prevent infinite loops

6. **Main focusTerminalWindow function**:
   - Dispatch to platform-specific implementation based on detectPlatform()
   - Import detectPlatform, execAsync from platform.ts

Use ESM imports with .js extensions. Follow existing codebase patterns.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - File exports FocusResult interface and focusTerminalWindow function
  </verify>
  <done>
    - windowFocusService.ts exists with all platform implementations
    - TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate windowFocusService into jumpService</name>
  <files>src/services/jumpService.ts</files>
  <action>
Update jumpService.ts to use windowFocusService for non-tmux sessions:

1. **Import focusTerminalWindow** from windowFocusService.js

2. **Update jumpToSession function**:
   - Instead of returning an error for non-tmux sessions, call focusTerminalWindow
   - Convert FocusResult to JumpResult format

   Replace this block:
   ```typescript
   if (!session.inTmux || !session.tmuxTarget) {
     return {
       success: false,
       message: `Cannot jump: ${session.projectName} is not in tmux`,
     };
   }
   ```

   With:
   ```typescript
   if (!session.inTmux || !session.tmuxTarget) {
     // Try to focus the terminal window for non-tmux sessions
     const result = await focusTerminalWindow(session);
     return {
       success: result.success,
       message: result.hint
         ? `${result.message}. ${result.hint}`
         : result.message,
     };
   }
   ```

The rest of the tmux jumping logic remains unchanged.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - jumpService imports from windowFocusService
    - Non-tmux sessions call focusTerminalWindow instead of returning error
  </verify>
  <done>
    - jumpService.ts updated
    - TypeScript compiles without errors
    - Non-tmux sessions attempt window focus instead of failing immediately
  </done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds
2. `npx tsc --noEmit` passes
3. Grep confirms windowFocusService exports focusTerminalWindow
4. Grep confirms jumpService imports and uses focusTerminalWindow
</verification>

<success_criteria>
- windowFocusService.ts exists with platform-specific focus implementations
- jumpService.ts calls focusTerminalWindow for non-tmux sessions
- Build passes without errors
- FocusResult includes hint field for user guidance
</success_criteria>

<output>
After completion, create `.planning/phases/06-terminal-integration/06-01-SUMMARY.md`
</output>
