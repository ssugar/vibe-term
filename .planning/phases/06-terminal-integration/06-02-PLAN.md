---
phase: 06-terminal-integration
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/services/windowFocusService.ts
  - src/stores/types.ts
  - src/stores/appStore.ts
  - src/app.tsx
autonomous: false

must_haves:
  truths:
    - "User can press 'b' key to return focus to HUD window"
    - "HUD window ID is saved on startup (Linux X11 only)"
    - "Help overlay shows 'b' key for return-to-HUD"
    - "Error auto-dismiss after 7 seconds for focus errors (longer for reading hints)"
  artifacts:
    - path: "src/services/windowFocusService.ts"
      provides: "HUD window ID save/restore functions"
      exports: ["saveHudWindowId", "returnToHud"]
    - path: "src/stores/types.ts"
      provides: "hudWindowId state field"
      contains: "hudWindowId"
    - path: "src/app.tsx"
      provides: "b key handler and HUD window save on mount"
  key_links:
    - from: "src/app.tsx"
      to: "src/services/windowFocusService.ts"
      via: "saveHudWindowId call on mount"
      pattern: "saveHudWindowId"
    - from: "src/app.tsx"
      to: "src/services/windowFocusService.ts"
      via: "returnToHud call on 'b' key"
      pattern: "returnToHud"
---

<objective>
Add quick-return-to-HUD functionality with 'b' key and update error handling for longer display time.

Purpose: Enable users to quickly return focus to HUD after jumping to a session (core user value).
Output: HUD window ID saved on startup, 'b' key returns focus, error timeout extended for hints.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-terminal-integration/06-01-SUMMARY.md

# Existing code to modify
@src/services/windowFocusService.ts
@src/stores/types.ts
@src/stores/appStore.ts
@src/app.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add saveHudWindowId and returnToHud to windowFocusService</name>
  <files>src/services/windowFocusService.ts</files>
  <action>
Add HUD window tracking functions to windowFocusService.ts:

1. **Module-level state** for HUD window ID:
   ```typescript
   let hudWindowId: string | null = null;
   ```

2. **saveHudWindowId function**:
   - Only works on Linux (X11) - check platform and !isWayland()
   - Use `xdotool getactivewindow` to get current window ID
   - Store in module-level hudWindowId variable
   - Return void, silently fail on error (non-critical)

   ```typescript
   export async function saveHudWindowId(): Promise<void> {
     if (detectPlatform() !== 'linux' || isWayland()) {
       return; // Only works on Linux X11
     }
     try {
       const { stdout } = await execAsync('xdotool getactivewindow');
       hudWindowId = stdout.trim();
     } catch {
       hudWindowId = null;
     }
   }
   ```

3. **returnToHud function**:
   - Return FocusResult
   - Check if hudWindowId is saved
   - Use `xdotool windowactivate <hudWindowId>` to restore focus
   - Return appropriate error if no window ID saved or on non-Linux

   ```typescript
   export async function returnToHud(): Promise<FocusResult> {
     if (!hudWindowId) {
       return {
         success: false,
         message: 'HUD window ID not saved',
         hint: 'Return-to-HUD only works on Linux X11',
       };
     }
     try {
       await execAsync(`xdotool windowactivate ${hudWindowId}`);
       return { success: true, message: 'Returned to HUD' };
     } catch {
       return {
         success: false,
         message: 'Failed to return to HUD',
       };
     }
   }
   ```
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - File exports saveHudWindowId and returnToHud functions
  </verify>
  <done>
    - windowFocusService.ts has saveHudWindowId and returnToHud functions
    - Functions handle Linux X11 only, graceful no-op elsewhere
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire 'b' key and HUD window save into app.tsx</name>
  <files>src/app.tsx</files>
  <action>
Update app.tsx to save HUD window ID on mount and handle 'b' key for return:

1. **Import new functions**:
   ```typescript
   import { saveHudWindowId, returnToHud } from './services/windowFocusService.js';
   ```

2. **Save HUD window ID on mount** - add to existing useEffect:
   ```typescript
   useEffect(() => {
     if (!initializedRef.current) {
       initializedRef.current = true;
       useAppStore.getState().setRefreshInterval(refreshInterval);
       useAppStore.getState().setLastRefresh(new Date());
       // Save HUD window ID for return-to-HUD feature
       saveHudWindowId();
     }
   }, [refreshInterval]);
   ```

3. **Add 'b' key handler** in useInput, after the error dismiss block (input === 'x'):
   ```typescript
   // b to return focus to HUD
   if (input === 'b') {
     returnToHud().then((result) => {
       if (!result.success) {
         useAppStore.getState().setError(result.hint || result.message);
         // Longer timeout for focus errors (7 seconds) to read hints
         setTimeout(() => {
           useAppStore.getState().setError(null);
         }, 7000);
       }
     });
     return;
   }
   ```

4. **Update error timeout for focus errors** in Enter key handler:
   Change the existing 3-second timeout to 7 seconds for consistency:
   ```typescript
   // Auto-clear error after 7 seconds (longer for focus hints)
   setTimeout(() => {
     useAppStore.getState().setError(null);
   }, 7000);
   ```

5. **Update help overlay** to include 'b' key:
   Add line after the "Jump to session" line:
   ```tsx
   <Text><Text dimColor>b</Text>      Back to HUD</Text>
   ```
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Help overlay shows 'b' key
    - 'b' key handler calls returnToHud
    - saveHudWindowId called on mount
  </verify>
  <done>
    - app.tsx imports and uses windowFocusService functions
    - 'b' key returns focus to HUD (on Linux X11)
    - Help shows 'b' key
    - Error timeout is 7 seconds
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify terminal integration end-to-end</name>
  <what-built>
    - Window focus service for non-tmux sessions (Linux X11, macOS, WSL2)
    - Return-to-HUD with 'b' key
    - Extended error timeout (7 seconds) for reading hints
    - Updated help overlay
  </what-built>
  <how-to-verify>
    1. Start HUD: `npm start`
    2. Press `?` - verify help shows 'b' key for "Back to HUD"
    3. If you have a non-tmux Claude session:
       - Select it with j/k or number keys
       - Press Enter - should attempt to focus terminal window
       - If xdotool not installed, should show error with install hint
    4. For tmux sessions: Enter should still work as before (switch-client)
    5. Press 'b' - should return focus to HUD (Linux X11 only)
    6. If on macOS/WSL2: 'b' should show graceful error about X11 only
    7. Errors should auto-dismiss after ~7 seconds
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. `npm run build` succeeds
2. `npm start` launches HUD
3. Help overlay shows 'b' key
4. Focus errors show for 7 seconds before auto-dismiss
5. Non-tmux sessions attempt window focus
6. 'b' key attempts HUD return
</verification>

<success_criteria>
- All phase 6 requirements met:
  - TERM-03: tmux session switching (preserved from Phase 5)
  - TERM-05: Non-tmux terminal window focus with graceful fallback
- Quick return to HUD implemented (user core value)
- Errors display long enough to read installation hints
- Human verification confirms end-to-end functionality
</success_criteria>

<output>
After completion, create `.planning/phases/06-terminal-integration/06-02-SUMMARY.md`
</output>
