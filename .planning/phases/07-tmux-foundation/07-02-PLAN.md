---
phase: 07-tmux-foundation
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/cli.tsx
  - package.json
  - src/services/tmuxService.ts
autonomous: true

must_haves:
  truths:
    - "Running claude-terminal from outside tmux creates and attaches to session"
    - "Running claude-terminal from inside different tmux session switches to claude-terminal"
    - "Running claude-terminal from inside claude-terminal session proceeds to render HUD"
    - "tmux session has status bar disabled"
    - "tmux session has mouse enabled"
    - "HUD pane is created at top with 2 lines height (by default)"
  artifacts:
    - path: "src/cli.tsx"
      provides: "Entry point that calls startup before Ink"
      contains: "ensureTmuxEnvironment"
      min_lines: 80
    - path: "package.json"
      provides: "Binary renamed to claude-terminal"
      contains: "claude-terminal"
    - path: "src/services/tmuxService.ts"
      provides: "Session configuration and HUD pane creation"
      exports: ["configureSession", "createHudLayout"]
  key_links:
    - from: "src/cli.tsx"
      to: "src/startup.ts"
      via: "import and call ensureTmuxEnvironment"
      pattern: "ensureTmuxEnvironment\\(\\)"
    - from: "src/cli.tsx"
      to: "src/services/tmuxService.ts"
      via: "configureSession call"
      pattern: "configureSession\\(\\)"
---

<objective>
Integrate startup orchestration into CLI entry point and configure the tmux session.

Purpose: The CLI must call the startup module before rendering Ink, handle the result appropriately, and configure the tmux session with proper options. This is the core integration that makes the tmux-managed environment work.

Output: Modified CLI that orchestrates tmux startup, renamed binary, extended tmux service with session configuration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-tmux-foundation/07-CONTEXT.md
@.planning/phases/07-tmux-foundation/07-RESEARCH.md
@.planning/phases/07-tmux-foundation/07-01-SUMMARY.md

# Files being modified
@src/cli.tsx
@package.json
@src/services/tmuxService.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate startup into CLI and rename binary</name>
  <files>src/cli.tsx, package.json</files>
  <action>
**Part A: Update package.json**

1. Change `"name"` from `"cc-tui-hud"` to `"claude-terminal"`
2. Change `"description"` to `"Claude Terminal - Manage multiple Claude Code instances in tmux"`
3. Change `"bin"` from `"cc-tui-hud"` to `"claude-terminal"`:
   ```json
   "bin": {
     "claude-terminal": "dist/cli.js"
   }
   ```
4. Update repository URL from `cc-tui-hud` to `claude-terminal`
5. Update bugs URL and homepage similarly

**Part B: Refactor src/cli.tsx**

1. Add imports at top:
   ```typescript
   import { ensureTmuxEnvironment, TMUX_SESSION_NAME } from './startup.js';
   import { loadConfig } from './services/configService.js';
   import { configureSession, createHudLayout } from './services/tmuxService.js';
   ```

2. Update meow help text:
   ```typescript
   `
   Usage
     $ claude-terminal

   Options
     --refresh, -r  Refresh interval in seconds (default: 2)

   Examples
     $ claude-terminal
     $ claude-terminal --refresh 5
   `
   ```

3. **Before** any Ink rendering, add startup orchestration:
   ```typescript
   // Step 1: Ensure tmux environment
   const startupResult = ensureTmuxEnvironment();

   if (!startupResult.success) {
     console.error(startupResult.error);
     process.exit(1);
   }

   if (!startupResult.shouldRenderInk) {
     // Returned from tmux attach/new-session (user detached or killed)
     process.exit(0);
   }

   // Step 2: Load config
   const config = loadConfig();

   // Step 3: Configure tmux session (async, but we're now inside tmux)
   await configureSession(TMUX_SESSION_NAME);

   // Step 4: Create HUD layout
   const layout = await createHudLayout(config.hudPosition, config.hudHeight);

   // Step 5: Check terminal size and warn if too small
   const { rows } = process.stdout;
   if (rows && rows < 10) {
     console.error(`Warning: Terminal height (${rows} rows) is very small. HUD may not display correctly.`);
   }
   ```

4. Keep the existing Ink render, Ctrl+C handling, and shutdown logic

**Note:** The startup sequence is:
1. ensureTmuxEnvironment() - synchronous, may not return if attaching
2. loadConfig() - synchronous
3. configureSession() - async (we're now in tmux, safe to use execAsync)
4. createHudLayout() - async
5. Ink render
  </action>
  <verify>
    - `npm run typecheck` passes
    - `grep "claude-terminal" package.json` shows the new name
    - `grep "ensureTmuxEnvironment" src/cli.tsx` shows the startup call
  </verify>
  <done>
    - package.json has binary renamed to claude-terminal
    - cli.tsx calls ensureTmuxEnvironment before Ink render
    - cli.tsx handles startup result (error, shouldRenderInk)
    - cli.tsx calls configureSession and createHudLayout
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend tmuxService with session configuration and HUD layout</name>
  <files>src/services/tmuxService.ts</files>
  <action>
Add the following new functions to `src/services/tmuxService.ts`:

**1. configureSession function:**
```typescript
/**
 * Configure tmux session options for claude-terminal.
 * Options are scoped to the specific session (not global).
 * Should be called after session creation/attachment.
 */
export async function configureSession(sessionName: string): Promise<void> {
  const options = [
    // Disable status bar - HUD replaces it
    `set-option -t ${sessionName} status off`,
    // Enable mouse for pane selection/scrolling
    `set-option -t ${sessionName} mouse on`,
    // Fast escape time for responsive key handling
    `set-option -t ${sessionName} escape-time 0`,
    // Increase history limit
    `set-option -t ${sessionName} history-limit 10000`,
  ];

  for (const opt of options) {
    await execAsync(`tmux ${opt}`);
  }
}
```

**2. createHudLayout function:**
```typescript
/**
 * Result of HUD layout creation
 */
export interface HudLayout {
  hudPaneId: string;
  mainPaneId: string;
}

/**
 * Create the HUD pane layout within the current window.
 * Creates a fixed-height pane at top or bottom for the HUD strip.
 *
 * @param position - 'top' or 'bottom' for HUD placement
 * @param height - Number of lines for HUD pane (1-3)
 * @returns Pane IDs for HUD and main panes
 */
export async function createHudLayout(
  position: 'top' | 'bottom',
  height: number
): Promise<HudLayout> {
  // Get current pane ID (will become main pane after split)
  const { stdout: currentPane } = await execAsync(
    `tmux display-message -p '#{pane_id}'`
  );

  // Split options:
  // -v: vertical split (top/bottom)
  // -b: place new pane before (above) - used for top position
  // -l N: exact line height
  // -P -F: print new pane ID
  const splitArgs = position === 'top'
    ? `-v -b -l ${height}`
    : `-v -l ${height}`;

  const { stdout: hudPane } = await execAsync(
    `tmux split-window ${splitArgs} -P -F '#{pane_id}'`
  );

  // After split:
  // - For top: new pane (HUD) is above, current pane (main) is below
  // - For bottom: new pane (HUD) is below, current pane (main) is above

  return {
    hudPaneId: hudPane.trim(),
    mainPaneId: currentPane.trim(),
  };
}
```

**3. Add type export:**
Make sure `HudLayout` is exported from the module.

**Note:** The HUD pane is created but the HUD itself doesn't run there yet - that's Phase 8 (HUD Strip UI). For Phase 7, we're just establishing the tmux infrastructure.

**IMPORTANT:** For Phase 7, the HUD (Ink app) will render in the current pane after the split is created. The actual movement of the HUD into the small pane and Claude sessions into the main pane is Phase 8-9 scope. In Phase 7, we just verify the layout gets created correctly.
  </action>
  <verify>
    - `npm run typecheck` passes
    - `grep -E "export (async function|interface)" src/services/tmuxService.ts` shows configureSession, createHudLayout, HudLayout
    - tmuxService.ts compiles without errors
  </verify>
  <done>
    - configureSession function sets session-specific tmux options
    - createHudLayout function creates split with specified position/height
    - HudLayout interface exported
    - Functions use session-scoped options (no -g flag)
  </done>
</task>

</tasks>

<verification>
Run after both tasks complete:

```bash
# Type checking
npm run typecheck

# Verify binary name changed
grep -o '"claude-terminal"' package.json

# Verify startup integration
grep "ensureTmuxEnvironment" src/cli.tsx
grep "configureSession" src/cli.tsx
grep "createHudLayout" src/cli.tsx

# Verify new tmux functions
grep -E "export async function (configureSession|createHudLayout)" src/services/tmuxService.ts

# Build to ensure everything compiles
npm run build
```
</verification>

<success_criteria>
- package.json has binary renamed to claude-terminal
- cli.tsx integrates startup orchestration before Ink render
- tmuxService.ts has configureSession and createHudLayout functions
- All files compile without TypeScript errors
- Build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/07-tmux-foundation/07-02-SUMMARY.md`
</output>
