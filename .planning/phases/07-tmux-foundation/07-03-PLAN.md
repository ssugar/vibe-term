---
phase: 07-tmux-foundation
plan: 03
type: execute
wave: 3
depends_on: ["07-02"]
files_modified:
  - src/app.tsx
autonomous: false

must_haves:
  truths:
    - "Pressing q key shows quit confirmation prompt"
    - "Pressing d in quit prompt detaches from tmux session"
    - "Pressing k in quit prompt kills the tmux session"
    - "Pressing Escape or n in quit prompt cancels and returns to HUD"
    - "User can start claude-terminal and land in working tmux environment"
  artifacts:
    - path: "src/app.tsx"
      provides: "Quit handler with detach/kill prompt"
      contains: "detach-client"
      contains: "kill-session"
  key_links:
    - from: "src/app.tsx"
      to: "tmux detach-client"
      via: "spawnSync on 'd' key"
      pattern: "detach-client"
    - from: "src/app.tsx"
      to: "tmux kill-session"
      via: "spawnSync on 'k' key"
      pattern: "kill-session"
---

<objective>
Implement quit behavior with detach/kill prompt and verify the complete Phase 7 flow.

Purpose: When users press 'q' to quit, they should be prompted to either detach (keep session alive for later) or kill (cleanup completely). This completes the Phase 7 feature set and includes human verification of the tmux integration.

Output: Modified App component with quit prompt, verified working tmux integration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-tmux-foundation/07-CONTEXT.md
@.planning/phases/07-tmux-foundation/07-RESEARCH.md
@.planning/phases/07-tmux-foundation/07-01-SUMMARY.md
@.planning/phases/07-tmux-foundation/07-02-SUMMARY.md

# Files being modified
@src/app.tsx
@src/startup.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement quit handler with detach/kill prompt</name>
  <files>src/app.tsx</files>
  <action>
Modify `src/app.tsx` to add quit confirmation with detach/kill options:

**1. Add import:**
```typescript
import { spawnSync } from 'child_process';
import { TMUX_SESSION_NAME } from './startup.js';
```

**2. Add quit state:**
In the App component, add state for quit confirmation:
```typescript
const [quitMode, setQuitMode] = useState<'none' | 'confirming'>('none');
```

**3. Modify the existing key handler (in useInput or wherever 'q' is handled):**

Replace or modify the existing quit behavior:
```typescript
// Handle 'q' key for quit
if (input === 'q' && !confirmingExit) {
  if (quitMode === 'none') {
    setQuitMode('confirming');
    return;
  }
}

// Handle quit confirmation keys
if (quitMode === 'confirming') {
  if (input === 'd') {
    // Detach: session stays alive
    spawnSync('tmux', ['detach-client'], { stdio: 'inherit' });
    exit();
  } else if (input === 'k') {
    // Kill: cleanup completely
    spawnSync('tmux', ['kill-session', '-t', TMUX_SESSION_NAME], { stdio: 'inherit' });
    exit();
  } else if (key.escape || input === 'n') {
    // Cancel
    setQuitMode('none');
  }
  return;
}
```

**4. Add quit prompt UI:**
In the render output, show the quit prompt when `quitMode === 'confirming'`:

```tsx
{quitMode === 'confirming' && (
  <Box marginTop={1}>
    <Text>
      Quit: <Text color="yellow">[d]</Text>etach (keep session) |
      <Text color="red">[k]</Text>ill (cleanup) |
      <Text color="gray">[n/Esc]</Text> cancel
    </Text>
  </Box>
)}
```

Position this appropriately in the layout (above Footer or replacing Footer when in quit mode).

**5. Ensure quit mode takes priority:**
When `quitMode === 'confirming'`, other key handlers (navigation, etc.) should be blocked or return early.

**Note:** The existing two-stage Ctrl+C exit in cli.tsx should remain for emergency exits. The 'q' key quit with prompt is the normal user-facing quit flow.
  </action>
  <verify>
    - `npm run typecheck` passes
    - `grep "detach-client" src/app.tsx` shows the detach command
    - `grep "kill-session" src/app.tsx` shows the kill command
    - `grep "quitMode" src/app.tsx` shows the state variable
  </verify>
  <done>
    - app.tsx has quitMode state
    - Pressing q shows quit prompt
    - Pressing d detaches from tmux
    - Pressing k kills tmux session
    - Pressing n or Escape cancels quit prompt
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Phase 7 tmux foundation:
- Startup module that ensures tmux environment
- Config service for user preferences
- CLI integration that orchestrates startup before Ink
- tmux session configuration (status off, mouse on)
- HUD pane layout creation (2-line split at top)
- Quit handler with detach/kill options
- Binary renamed from cc-tui-hud to claude-terminal
  </what-built>
  <how-to-verify>

**Test 1: Fresh start from regular terminal**
1. Open a terminal that is NOT inside tmux
2. Run: `npm run dev` (or `npm run build && node dist/cli.js`)
3. Expected: You should be placed into a tmux session named "claude-terminal"
4. Verify: Run `tmux list-sessions` in another terminal - should show "claude-terminal" session

**Test 2: Verify tmux configuration**
1. While in the claude-terminal session, check:
   - No tmux status bar visible at bottom (status off)
   - Mouse scrolling works in panes (mouse on)
2. Run: `tmux show-options -t claude-terminal status` - should show "off"

**Test 3: HUD pane layout**
1. Verify the terminal has been split
2. There should be a small pane (2 lines) at the top
3. The HUD should be rendering in one of the panes

**Test 4: Quit behavior**
1. Press 'q' - quit prompt should appear
2. Press 'n' or Escape - prompt should disappear, back to normal HUD
3. Press 'q' again, then 'd' - should detach (terminal shows detached message)
4. Run `tmux list-sessions` - claude-terminal should still exist
5. Run `tmux attach -t claude-terminal` to reattach

**Test 5: Kill session**
1. While attached, press 'q' then 'k'
2. Session should be killed
3. Run `tmux list-sessions` - claude-terminal should NOT exist

**Test 6: Start when already in claude-terminal session**
1. Start the HUD fresh: `npm run dev`
2. Detach with 'q' + 'd'
3. Reattach with `tmux attach -t claude-terminal`
4. Run `npm run dev` again from inside the session
5. Expected: Should proceed directly to rendering (not try to create new session)

**Test 7: Start from different tmux session**
1. Create a different tmux session: `tmux new-session -s other`
2. Run `npm run dev` from inside "other"
3. Expected: Should switch you to claude-terminal session

**Test 8: Missing tmux error**
1. If you have a way to test without tmux (unlikely), or:
2. Verify the error message text exists in startup.ts:
   `grep -A5 "tmux is not installed" src/startup.ts`

  </how-to-verify>
  <resume-signal>Type "approved" if all tests pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
Before checkpoint, run:

```bash
# Build and type check
npm run typecheck
npm run build

# Verify all key files exist and have expected content
ls -la src/startup.ts src/services/configService.ts
grep "ensureTmuxEnvironment" src/cli.tsx
grep "configureSession" src/cli.tsx
grep "createHudLayout" src/cli.tsx
grep "quitMode" src/app.tsx

# Verify package name
grep '"name":' package.json
```
</verification>

<success_criteria>
- All 8 verification tests pass
- No TypeScript errors
- Build succeeds
- User can seamlessly enter and exit the tmux-managed environment
- Quit prompt works correctly with detach/kill options
</success_criteria>

<output>
After completion and human approval, create `.planning/phases/07-tmux-foundation/07-03-SUMMARY.md`
</output>
