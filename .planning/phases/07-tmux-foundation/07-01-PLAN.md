---
phase: 07-tmux-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/startup.ts
  - src/services/configService.ts
autonomous: true

must_haves:
  truths:
    - "Startup module detects whether tmux is installed"
    - "Startup module detects whether currently inside tmux"
    - "Startup module identifies current tmux session name if applicable"
    - "Config service loads user configuration from ~/.config/claude-terminal/config.json"
    - "Config service returns defaults when config file missing"
  artifacts:
    - path: "src/startup.ts"
      provides: "tmux environment detection and session orchestration"
      exports: ["ensureTmuxEnvironment", "StartupResult"]
      min_lines: 60
    - path: "src/services/configService.ts"
      provides: "User configuration loading with defaults"
      exports: ["loadConfig", "Config", "DEFAULT_CONFIG"]
      min_lines: 30
  key_links:
    - from: "src/startup.ts"
      to: "child_process.spawnSync"
      via: "tmux CLI commands"
      pattern: "spawnSync.*tmux"
    - from: "src/services/configService.ts"
      to: "~/.config/claude-terminal/config.json"
      via: "fs.readFileSync"
      pattern: "readFileSync.*config"
---

<objective>
Create the foundational infrastructure for tmux startup orchestration.

Purpose: Before Ink renders, the application must ensure it's running inside the managed `claude-terminal` tmux session. This plan creates the startup module that handles tmux detection and the config service for user preferences.

Output: Two new modules - `startup.ts` for tmux environment orchestration, `configService.ts` for loading user configuration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-tmux-foundation/07-CONTEXT.md
@.planning/phases/07-tmux-foundation/07-RESEARCH.md

# Existing code patterns
@src/services/platform.ts
@src/services/tmuxService.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create startup module for tmux environment orchestration</name>
  <files>src/startup.ts</files>
  <action>
Create `src/startup.ts` with the following functionality:

1. **Constants:**
   - `TMUX_SESSION_NAME = 'claude-terminal'`

2. **Types:**
   - `StartupResult`: `{ success: boolean; error?: string; shouldRenderInk: boolean }`
   - `TmuxEnvironment`: `{ inTmux: boolean; sessionName?: string }`

3. **Functions:**

`checkTmuxAvailable(): boolean`
- Use `spawnSync('tmux', ['-V'])` to check if tmux is installed
- Return `status === 0`

`getTmuxEnvironment(): TmuxEnvironment`
- Check `process.env.TMUX` for tmux detection
- If in tmux, get current session name via `spawnSync('tmux', ['display-message', '-p', '#{session_name}'])`
- Return `{ inTmux, sessionName }`

`ensureTmuxEnvironment(): StartupResult`
- Main orchestration function with this logic:

```
1. Check tmux availability
   - If unavailable: return { success: false, error: install message, shouldRenderInk: false }

2. Get tmux environment

3. If already in claude-terminal session:
   - return { success: true, shouldRenderInk: true }

4. Check if claude-terminal session exists:
   - spawnSync('tmux', ['has-session', '-t', TMUX_SESSION_NAME])

5. If inside tmux but different session:
   - If claude-terminal exists: switch-client to it
   - If not: create detached session, then switch-client
   - return { success: true, shouldRenderInk: true }

6. If outside tmux:
   - Use spawnSync with stdio: 'inherit' to attach/create session
   - spawnSync('tmux', ['new-session', '-A', '-s', TMUX_SESSION_NAME], { stdio: 'inherit' })
   - After this returns (user detached/killed), return { success: true, shouldRenderInk: false }
```

**Error message for missing tmux:**
```
tmux is not installed.

Install with:
  - Debian/Ubuntu: sudo apt install tmux
  - macOS: brew install tmux
  - Fedora: sudo dnf install tmux
```

**Important:** Use `spawnSync` from `child_process` (NOT the async exec pattern from platform.ts). Startup must be synchronous and block until tmux environment is established.
  </action>
  <verify>
    - `npm run typecheck` passes
    - File exports `ensureTmuxEnvironment`, `StartupResult`, `TMUX_SESSION_NAME`
    - Module uses `spawnSync` (not `exec` or `execAsync`)
  </verify>
  <done>
    - startup.ts exists with 60+ lines
    - Exports ensureTmuxEnvironment function
    - Handles all 4 scenarios: no tmux, already in session, different tmux session, outside tmux
  </done>
</task>

<task type="auto">
  <name>Task 2: Create config service with defaults</name>
  <files>src/services/configService.ts</files>
  <action>
Create `src/services/configService.ts` with the following:

1. **Types:**
```typescript
export interface Config {
  hudPosition: 'top' | 'bottom';
  hudHeight: 1 | 2 | 3;
}
```

2. **Constants:**
```typescript
export const DEFAULT_CONFIG: Config = {
  hudPosition: 'top',
  hudHeight: 2,
};

const CONFIG_PATH = join(homedir(), '.config', 'claude-terminal', 'config.json');
```

3. **Functions:**

`loadConfig(): Config`
- Check if config file exists using `existsSync`
- If not, return `DEFAULT_CONFIG`
- If exists, try to parse JSON
- Merge with defaults to handle partial configs: `{ ...DEFAULT_CONFIG, ...parsed }`
- On parse error, log warning to stderr and return `DEFAULT_CONFIG`
- Validate values (hudPosition must be 'top' or 'bottom', hudHeight must be 1, 2, or 3)

**Imports needed:**
- `import { readFileSync, existsSync } from 'fs';`
- `import { join } from 'path';`
- `import { homedir } from 'os';`

**Note:** Do NOT create the config file automatically. Users create it manually if they want non-default settings.
  </action>
  <verify>
    - `npm run typecheck` passes
    - File exports `Config`, `DEFAULT_CONFIG`, `loadConfig`
    - Function handles missing file gracefully (returns defaults)
  </verify>
  <done>
    - configService.ts exists with 30+ lines
    - Exports Config type, DEFAULT_CONFIG constant, loadConfig function
    - Returns DEFAULT_CONFIG when file missing or invalid
  </done>
</task>

</tasks>

<verification>
Run after both tasks complete:

```bash
# Type checking
npm run typecheck

# Verify exports exist
grep -E "export (function|const|interface|type)" src/startup.ts
grep -E "export (function|const|interface|type)" src/services/configService.ts

# Verify spawnSync usage (not exec)
grep -c "spawnSync" src/startup.ts  # Should be > 0
grep -c "execAsync\|exec(" src/startup.ts  # Should be 0
```
</verification>

<success_criteria>
- Both files exist and compile without errors
- startup.ts handles all tmux environment scenarios
- configService.ts loads config with proper defaults
- No async operations in startup.ts (pure spawnSync)
- Types are properly exported for use in other modules
</success_criteria>

<output>
After completion, create `.planning/phases/07-tmux-foundation/07-01-SUMMARY.md`
</output>
