---
phase: 01-foundation
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - src/cli.tsx
autonomous: false

must_haves:
  truths:
    - "HUD launches and renders basic UI frame"
    - "HUD exits cleanly with Ctrl+C (two-stage: first warns, second exits)"
    - "HUD exits cleanly with 'q' then 'y' confirmation"
    - "--refresh flag changes polling interval"
    - "TypeScript compilation succeeds"
  artifacts:
    - path: "src/cli.tsx"
      provides: "Entry point with CLI argument parsing and graceful shutdown"
      exports: []
  key_links:
    - from: "src/cli.tsx"
      to: "src/app.tsx"
      via: "render(<App />)"
      pattern: "render.*App"
    - from: "src/cli.tsx"
      to: "ink"
      via: "render function"
      pattern: "import.*render.*from.*ink"
---

<objective>
Create the CLI entry point with meow argument parsing and graceful shutdown handling. Verify the complete HUD launches, renders correctly, and exits cleanly.

Purpose: This completes Phase 1 by wiring everything together and verifying the HUD meets all success criteria.
Output: Working CLI that launches the HUD with proper argument handling and shutdown behavior.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-CONTEXT.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
@.planning/phases/01-foundation/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: CLI Entry Point</name>
  <files>
    - src/cli.tsx
  </files>
  <action>
Create the CLI entry point following Pattern 5 (Graceful Shutdown) from RESEARCH.md:

Create src/cli.tsx:
```typescript
#!/usr/bin/env node
import React from 'react';
import { render } from 'ink';
import meow from 'meow';
import App from './app.js';
import { useAppStore } from './stores/appStore.js';

const cli = meow(
  `
  Usage
    $ cc-tui-hud

  Options
    --refresh, -r  Refresh interval in seconds (default: 2)

  Examples
    $ cc-tui-hud
    $ cc-tui-hud --refresh 5
    $ cc-tui-hud -r 1
`,
  {
    importMeta: import.meta,
    flags: {
      refresh: {
        type: 'number',
        shortFlag: 'r',
        default: 2,
      },
    },
  }
);

// Convert seconds to milliseconds
const refreshInterval = cli.flags.refresh * 1000;

// Track Ctrl+C presses for two-stage exit
let ctrlCPressed = false;
let ctrlCTimeout: NodeJS.Timeout | null = null;

// Render the app with Ctrl+C handling disabled (we handle it manually)
const { unmount, waitUntilExit } = render(
  <App refreshInterval={refreshInterval} />,
  { exitOnCtrlC: false }
);

// Graceful shutdown function
const shutdown = () => {
  unmount();
  process.exit(0);
};

// Handle SIGINT (Ctrl+C) with two-stage exit per CONTEXT.md
process.on('SIGINT', () => {
  if (ctrlCPressed) {
    // Second Ctrl+C - force exit
    shutdown();
  } else {
    // First Ctrl+C - show warning via store
    ctrlCPressed = true;
    useAppStore.getState().setConfirmingExit(true);

    // Reset after 2 seconds if no second Ctrl+C
    ctrlCTimeout = setTimeout(() => {
      ctrlCPressed = false;
      useAppStore.getState().setConfirmingExit(false);
    }, 2000);
  }
});

// Handle SIGTERM
process.on('SIGTERM', shutdown);

// Wait for app to exit (triggered by exit() in useApp hook)
await waitUntilExit();

// Clean up timeout if still pending
if (ctrlCTimeout) {
  clearTimeout(ctrlCTimeout);
}
```

Key implementation details:
- Uses meow for CLI argument parsing (--refresh/-r flag)
- exitOnCtrlC: false to handle Ctrl+C manually
- Two-stage Ctrl+C: first shows confirmation, second force exits (per CONTEXT.md)
- 2-second timeout resets Ctrl+C state if user doesn't press again
- Clean exit on SIGTERM
- Uses useAppStore.getState() for accessing store outside React
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - src/cli.tsx exists
    - Shebang line present: `head -1 src/cli.tsx`
  </verify>
  <done>
    CLI entry point created with meow argument parsing.
    Two-stage Ctrl+C exit implemented.
    Graceful shutdown on SIGTERM.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build and Verify</name>
  <files>(none - verification only)</files>
  <action>
Build the project and verify everything works:

1. Run TypeScript compilation check:
   ```bash
   npm run typecheck
   ```

2. Run dev mode to verify the HUD launches:
   ```bash
   npm run dev
   ```
   - HUD should display with header ("Claude Code HUD - No sessions")
   - Empty state ASCII art should appear
   - Footer should show key hints and "Updated Xs ago"
   - Press 'q' to trigger exit confirmation
   - Press 'y' to confirm exit (should exit cleanly)

3. Test --refresh flag:
   ```bash
   npm run dev -- --refresh 1
   ```
   - Footer should update "Updated Xs ago" every second

4. Test two-stage Ctrl+C:
   - Launch with `npm run dev`
   - Press Ctrl+C once - should show "Quit HUD?" confirmation
   - Wait 2 seconds - confirmation should disappear
   - Press Ctrl+C twice quickly - should force exit

5. Verify clean exit (no orphan processes, no memory warnings):
   ```bash
   npm run dev
   # Press q then y to exit
   echo $?  # Should be 0
   ```
  </action>
  <verify>
    - `npm run typecheck` exits with code 0
    - `npm run dev` launches HUD and renders correctly
    - Exit with q+y works cleanly
    - Two-stage Ctrl+C works as designed
  </verify>
  <done>
    TypeScript compilation succeeds.
    HUD launches and renders UI frame.
    Exit behavior works correctly.
    --refresh flag works.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Phase 1 foundation: project setup, TypeScript strict mode, Zustand store, all UI components (Header, Footer, EmptyState, SessionList), CLI entry point with graceful shutdown.
  </what-built>
  <how-to-verify>
1. Launch the HUD:
   ```bash
   cd /home/ssugar/claude/cc-tui-hud
   npm run dev
   ```

2. Verify visual appearance:
   - Header shows "Claude Code HUD - No sessions" with blue border
   - Main area shows ASCII art: "No Claude Code sessions"
   - Footer shows key hints (j/k, enter, q, ?) and "Updated Xs ago"

3. Test keyboard shortcuts:
   - Press '?' - help overlay should appear
   - Press any key - help should dismiss
   - Press 'q' - "Quit HUD?" confirmation should appear
   - Press 'n' - confirmation should dismiss
   - Press 'q' then 'y' - HUD should exit cleanly to shell

4. Test Ctrl+C behavior:
   - Restart with `npm run dev`
   - Press Ctrl+C once - should show quit confirmation
   - Wait 2 seconds - confirmation should disappear
   - Press Ctrl+C twice quickly - should force exit

5. Test --refresh flag:
   ```bash
   npm run dev -- --refresh 1
   ```
   - Footer "Updated Xs ago" should increment every second
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
Phase 1 Success Criteria from ROADMAP.md:
1. HUD launches and renders basic UI frame (header, empty list area, footer)
2. HUD runs without errors on Linux, macOS, and WSL2
3. HUD exits cleanly with Ctrl+C (no orphan processes, no memory leak warnings)
4. TypeScript compilation succeeds with strict mode
</verification>

<success_criteria>
- `npm run typecheck` passes
- `npm run dev` launches HUD successfully
- Header, EmptyState, Footer all render correctly
- q+y exit works cleanly
- Ctrl+C two-stage exit works
- --refresh flag changes polling interval
- Human verification confirms visual appearance
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-03-SUMMARY.md`
</output>
