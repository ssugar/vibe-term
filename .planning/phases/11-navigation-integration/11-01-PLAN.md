---
phase: 11-navigation-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app.tsx
  - src/components/HudStrip.tsx
  - src/stores/appStore.ts
  - src/hooks/useSessions.ts
autonomous: false

must_haves:
  truths:
    - "User can navigate sessions with j/k or arrow keys without going out of bounds"
    - "User can quick-jump to sessions 1-9 with number keys"
    - "Invalid number key (e.g., 9 with 3 sessions) shows 'No session 9' message"
    - "User can switch to selected session with Enter key"
    - "User can quit HUD with q key and see warning about active sessions"
    - "User can view help with ? key showing all bindings including Ctrl+h"
    - "selectedIndex stays valid when sessions are removed"
    - "HUD shows visual distinction when focused vs unfocused"
    - "Keybinding hints only shown when HUD is focused"
    - "Failed session switch shows error and removes dead session from list"
  artifacts:
    - path: "src/app.tsx"
      provides: "Error message for invalid number keys"
      contains: "No session"
    - path: "src/components/HudStrip.tsx"
      provides: "Help text with Ctrl+h, quit warning, focus-aware hints"
      contains: "Ctrl+h"
    - path: "src/stores/appStore.ts"
      provides: "hudFocused state for focus tracking"
      contains: "hudFocused"
    - path: "src/hooks/useSessions.ts"
      provides: "Dead session cleanup on detection"
      contains: "removeSession"
  key_links:
    - from: "src/app.tsx"
      to: "error state"
      via: "setError for invalid hotkey"
      pattern: "No session.*setError"
    - from: "src/components/HudStrip.tsx"
      to: "hudFocused state"
      via: "conditional hint rendering"
      pattern: "hudFocused.*dimColor"
---

<objective>
Implement all navigation polish from 11-CONTEXT.md decisions:

1. Error feedback for invalid hotkeys ("No session N")
2. Quit confirmation warns about active session termination
3. Help text includes Ctrl+h binding
4. Focus detection with visual distinction and conditional hints
5. Dead session cleanup on failed switch

This builds on existing navigation code (j/k, arrows, 1-9, Enter, q, ?) which is already functional.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-navigation-integration/11-CONTEXT.md
@.planning/phases/11-navigation-integration/11-RESEARCH.md

# Key source files
@src/app.tsx
@src/stores/appStore.ts
@src/components/HudStrip.tsx
@src/hooks/useSessions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add error feedback for invalid number keys</name>
  <files>src/app.tsx</files>
  <action>
In the number hotkey handler (around line 292-298), add error feedback when the target session doesn't exist.

Current implementation:
```typescript
// Number hotkeys 1-9 for quick-jump
if (/^[1-9]$/.test(input)) {
  const targetIndex = parseInt(input, 10) - 1;
  if (targetIndex < sessions.length) {
    useAppStore.getState().setSelectedIndex(targetIndex);
  }
  return;
}
```

Change to:
```typescript
// Number hotkeys 1-9 for quick-jump
if (/^[1-9]$/.test(input)) {
  const targetIndex = parseInt(input, 10) - 1;
  if (targetIndex < sessions.length) {
    useAppStore.getState().setSelectedIndex(targetIndex);
  } else {
    // Show error for invalid session number
    useAppStore.getState().setError(`No session ${input}`);
    setTimeout(() => {
      useAppStore.getState().setError(null);
    }, 1500);
  }
  return;
}
```

The 1.5 second duration aligns with the context decision "Claude's discretion: message display duration (suggest 1.5-2 seconds)".
  </action>
  <verify>
1. Run `npm run build` - should compile without errors
2. Run `npm run lint` - should pass
3. Read src/app.tsx and verify the number hotkey handler includes the error message
  </verify>
  <done>
Invalid number keys (e.g., pressing 9 with only 3 sessions) show "No session 9" error message for 1.5 seconds.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update quit confirmation to warn about session termination</name>
  <files>src/components/HudStrip.tsx</files>
  <action>
Update the quit prompt in HudStrip.tsx (around line 79-89) to warn users that choosing "kill" will terminate active Claude sessions.

Current implementation:
```tsx
{/* Quit prompt (q key) */}
{showQuitPrompt && (
  <Text>
    <Text color="yellow">Quit: </Text>
    <Text color="yellow" bold>[d]</Text>
    <Text>etach </Text>
    <Text dimColor>| </Text>
    <Text color="red" bold>[k]</Text>
    <Text>ill </Text>
    <Text dimColor>| </Text>
    <Text dimColor>[n/Esc] cancel</Text>
  </Text>
)}
```

Change to:
```tsx
{/* Quit prompt (q key) */}
{showQuitPrompt && (
  <Text>
    <Text color="yellow">Quit: </Text>
    <Text color="yellow" bold>[d]</Text>
    <Text>etach </Text>
    <Text dimColor>(sessions stay) </Text>
    <Text dimColor>| </Text>
    <Text color="red" bold>[k]</Text>
    <Text>ill </Text>
    <Text dimColor>(ends all sessions) </Text>
    <Text dimColor>| </Text>
    <Text dimColor>[n/Esc]</Text>
  </Text>
)}
```

This makes clear:
- Detach: sessions continue running (can reattach later)
- Kill: terminates all active Claude sessions
  </action>
  <verify>
1. Run `npm run build` - should compile without errors
2. Start the HUD and press 'q'
3. Verify the prompt shows "(sessions stay)" for detach and "(ends all sessions)" for kill
  </verify>
  <done>
Quit confirmation clearly indicates that detach preserves sessions while kill terminates them.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update help text to include Ctrl+h binding</name>
  <files>src/components/HudStrip.tsx</files>
  <action>
Update the help text in HudStrip.tsx (around line 103-106) to include the Ctrl+h binding for returning to HUD from main pane.

Current implementation:
```tsx
{/* Help text */}
{showHelpText && (
  <Text dimColor>
    j/k/←/→: nav | Enter: switch | 1-9/Alt+N: quick | n: new | q: quit
  </Text>
)}
```

Change to:
```tsx
{/* Help text */}
{showHelpText && (
  <Text dimColor>
    ←/→/j/k: nav | Enter: switch | 1-9: jump | n: new | q: quit | Ctrl+h: focus HUD
  </Text>
)}
```

Changes:
- Reordered to put arrows first (more discoverable)
- Removed "Alt+N" (not implemented, was incorrect)
- Changed "quick" to "jump" (clearer)
- Added "Ctrl+h: focus HUD" (from Phase 9 implementation)
  </action>
  <verify>
1. Run `npm run build` - should compile without errors
2. Start the HUD and press '?'
3. Verify help text shows "Ctrl+h: focus HUD"
  </verify>
  <done>
Help text shows all keybindings including Ctrl+h for returning focus to HUD.
  </done>
</task>

<task type="auto">
  <name>Task 4: Add focus detection and conditional hint visibility</name>
  <files>src/stores/appStore.ts, src/hooks/useSessions.ts, src/components/HudStrip.tsx</files>
  <action>
Implement focus tracking to show visual distinction when HUD is focused vs unfocused.

**Step 1: Add hudFocused state to appStore.ts**

Add to the store state (around line 8):
```typescript
hudFocused: true,
```

Add to the actions (around line 26):
```typescript
setHudFocused: (focused) => set({ hudFocused: focused }),
```

Update the AppState type in src/stores/types.ts to include:
```typescript
hudFocused: boolean;
setHudFocused: (focused: boolean) => void;
```

**Step 2: Poll focus state in useSessions.ts**

In the useSessions hook, add focus detection to the polling interval. After the session detection code, add:

```typescript
// Check if HUD pane is focused
execAsync('tmux display-message -p "#{pane_id}"')
  .then(({ stdout: currentPaneId }) => {
    execAsync('tmux show-environment CLAUDE_TERMINAL_HUD_PANE')
      .then(({ stdout: hudEnv }) => {
        const hudPaneId = hudEnv.split('=')[1]?.trim();
        const isFocused = currentPaneId.trim() === hudPaneId;
        useAppStore.getState().setHudFocused(isFocused);
      })
      .catch(() => {
        // If we can't determine focus, assume focused
        useAppStore.getState().setHudFocused(true);
      });
  })
  .catch(() => {
    useAppStore.getState().setHudFocused(true);
  });
```

**Step 3: Update HudStrip.tsx for focus-aware rendering**

Add hudFocused prop to HudStripProps interface:
```typescript
hudFocused?: boolean;
```

Update the component to receive the prop:
```typescript
export function HudStrip({
  showHelp,
  error,
  quitMode,
  isConfirmingExit,
  spawnMode,
  spawnInput,
  showMkdirPrompt,
  mkdirPath,
  completionCount = 0,
  hudFocused = true,
}: HudStripProps): React.ReactElement {
```

Add a keybinding hint line that only shows when focused (after TabStrip, before conditional line 2 content):

```tsx
{/* Keybinding hints - only when focused and no modal state */}
{hudFocused && !showMkdir && !showSpawnPrompt && !showQuitPrompt && !showExitConfirm && !showHelpText && !showError && (
  <Text dimColor>
    ←/→: nav | Enter: switch | n: new | q: quit | ?: help
  </Text>
)}
```

Update the Box wrapper to show focus indicator:
```tsx
<Box flexDirection="column" backgroundColor={hudFocused ? "#333333" : "#222222"}>
```

**Step 4: Pass hudFocused to HudStrip in app.tsx**

Add to store subscriptions:
```typescript
const hudFocused = useAppStore((state) => state.hudFocused);
```

Pass to HudStrip:
```tsx
<HudStrip
  showHelp={showHelp}
  error={error}
  quitMode={quitMode}
  isConfirmingExit={isConfirmingExit}
  spawnMode={spawnMode}
  spawnInput={spawnInput}
  showMkdirPrompt={showMkdirPrompt}
  mkdirPath={mkdirPath}
  completionCount={completions.length}
  hudFocused={hudFocused}
/>
```
  </action>
  <verify>
1. Run `npm run build` - should compile without errors
2. Run `npm run lint` - should pass
3. Start the HUD
4. When HUD is focused: keybinding hints visible, background darker (#333333)
5. Press Enter to switch to a session (focus main pane)
6. When HUD is unfocused: hints hidden, background lighter (#222222)
7. Press Ctrl+h to return to HUD: hints reappear
  </verify>
  <done>
HUD shows visual distinction (background color) and keybinding hints only when focused.
  </done>
</task>

<task type="auto">
  <name>Task 5: Handle dead session cleanup on failed switch</name>
  <files>src/app.tsx, src/stores/appStore.ts, src/stores/types.ts</files>
  <action>
When a session switch fails (session died), show an error AND remove the dead session from the list.

**Step 1: Add removeSession action to appStore.ts**

Add to the actions (after setSessions):
```typescript
removeSession: (sessionId) =>
  set((state) => {
    const newSessions = state.sessions.filter((s) => s.id !== sessionId);
    return {
      sessions: newSessions,
      // Clamp selectedIndex to valid range
      selectedIndex: Math.min(state.selectedIndex, Math.max(0, newSessions.length - 1)),
      // Clear activeSessionId if it was the removed session
      activeSessionId: state.activeSessionId === sessionId ? null : state.activeSessionId,
    };
  }),
```

Update AppState type in src/stores/types.ts:
```typescript
removeSession: (sessionId: string) => void;
```

**Step 2: Update switch failure handling in app.tsx**

In the internal session switch handler (around line 332-344), update the catch block:

Current:
```typescript
.catch((err) => {
  useAppStore.getState().setError(`Switch failed: ${err.message}`);
  setTimeout(() => {
    useAppStore.getState().setError(null);
  }, 5000);
});
```

Change to:
```typescript
.catch((err) => {
  // Session likely died - remove it and show error
  useAppStore.getState().removeSession(session.id);
  useAppStore.getState().setError(`Session ended - removed from list`);
  setTimeout(() => {
    useAppStore.getState().setError(null);
  }, 3000);
});
```

Similarly update the external session switch handler (around line 360-365):

Current:
```typescript
.catch((err) => {
  useAppStore.getState().setError(`Jump failed: ${err.message}`);
  setTimeout(() => {
    useAppStore.getState().setError(null);
  }, 5000);
});
```

Change to:
```typescript
.catch((err) => {
  // Session likely died - remove it and show error
  useAppStore.getState().removeSession(session.id);
  useAppStore.getState().setError(`Session ended - removed from list`);
  setTimeout(() => {
    useAppStore.getState().setError(null);
  }, 3000);
});
```
  </action>
  <verify>
1. Run `npm run build` - should compile without errors
2. Run `npm run lint` - should pass
3. Start the HUD with multiple sessions
4. Kill one of the Claude sessions externally (Ctrl+C in its pane)
5. Try to switch to that session with Enter
6. Verify: Error message "Session ended - removed from list" appears
7. Verify: Dead session is removed from the tab strip
8. Verify: selectedIndex adjusts to stay valid
  </verify>
  <done>
Failed session switches detect dead sessions, show user-friendly error, and clean up the session list.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 6: Validate all navigation and polish from 11-CONTEXT.md</name>
  <what-built>
All navigation polish from 11-CONTEXT.md decisions:
1. Error feedback for invalid number keys ("No session N")
2. Quit confirmation with session termination warning
3. Help text with Ctrl+h binding
4. Focus detection with visual distinction and conditional hints
5. Dead session cleanup on failed switch

Plus existing navigation (j/k, arrows, 1-9, Enter, q, ?) from v1.0.
  </what-built>
  <how-to-verify>
Start the HUD fresh and validate each context decision:

**Setup:**
1. Kill any existing session: `tmux kill-session -t claude-terminal 2>/dev/null`
2. Run `npm run dev` or `claude-terminal` to start fresh

**Error Feedback (from context: "Invalid hotkey shows status message"):**
- [ ] Press 9 with fewer than 9 sessions → shows "No session 9" for ~1.5s
- [ ] Press 5 with only 2 sessions → shows "No session 5"
- [ ] Error auto-dismisses (no action needed)
- [ ] Press x to manually dismiss error (optional)

**Quit Confirmation (from context: "shows confirmation noting sessions will be terminated"):**
- [ ] Press q → shows quit prompt
- [ ] Prompt shows "[d]etach (sessions stay)" - indicates sessions persist
- [ ] Prompt shows "[k]ill (ends all sessions)" - indicates termination
- [ ] Press n or Esc → cancels, returns to normal
- [ ] (Optional) Press d → detaches, sessions continue running
- [ ] (Optional) Press k → kills all, sessions terminated

**Help Display (from context: "Help shows all keybindings including Ctrl+h"):**
- [ ] Press ? → shows help text
- [ ] Help includes: ←/→/j/k, Enter, 1-9, n, q, Ctrl+h
- [ ] Press any key → dismisses help
- [ ] Dismissed key does NOT also navigate (e.g., j just dismisses)

**Focus Indicators (from context: "HUD shows border highlight when focused"):**
- [ ] When HUD is focused: background is darker (#333333)
- [ ] When HUD is focused: keybinding hints visible at bottom
- [ ] Press Enter to switch to session → focus moves to main pane
- [ ] When unfocused: background is lighter (#222222)
- [ ] When unfocused: keybinding hints hidden
- [ ] Press Ctrl+h → focus returns to HUD, hints reappear

**Dead Session Cleanup (from context: "Failed session switch shows message AND cleans up"):**
- [ ] Spawn 2+ sessions with 'n'
- [ ] In main pane, Ctrl+C to kill a Claude process
- [ ] Try to switch to the dead session (navigate to it, press Enter)
- [ ] Shows "Session ended - removed from list" error
- [ ] Dead session tab disappears from strip
- [ ] selectedIndex adjusts (no crash, no out-of-bounds)

**Core Navigation (verify still works):**
- [ ] j/Down/Right → moves selection right
- [ ] k/Up/Left → moves selection left
- [ ] Navigation stops at edges (no wrap)
- [ ] 1-9 → quick-jumps to that session number
- [ ] Enter → switches to selected session in main pane
- [ ] Active session shows underline marker
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe issues found.</resume-signal>
</task>

</tasks>

<verification>
All 11-CONTEXT.md decisions implemented:
- Error feedback: "No session N" message with 1.5s auto-dismiss
- Quit confirmation: Clear warning about session termination
- Help display: Includes Ctrl+h binding
- Focus indicators: Background color + conditional hints
- Dead session: Error message + automatic cleanup
- Core navigation: j/k, arrows, 1-9, Enter, q, ? all work
</verification>

<success_criteria>
1. `npm run build` passes
2. `npm run lint` passes
3. Invalid number key shows "No session N" error
4. Quit prompt warns about session termination
5. Help text includes Ctrl+h binding
6. HUD shows different background when focused vs unfocused
7. Keybinding hints only visible when HUD is focused
8. Failed session switch cleans up dead session
9. Human verification of all context decisions passes
</success_criteria>

<output>
After completion, create `.planning/phases/11-navigation-integration/11-01-SUMMARY.md`
</output>
