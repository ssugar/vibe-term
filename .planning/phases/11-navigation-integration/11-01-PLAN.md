---
phase: 11-navigation-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/stores/appStore.ts
  - src/services/tmuxService.ts
  - src/components/WelcomePane.tsx
autonomous: false

must_haves:
  truths:
    - "User can navigate sessions with j/k or arrow keys without going out of bounds"
    - "User can quick-jump to sessions 1-9 with number keys"
    - "User can switch to selected session with Enter key"
    - "User can quit HUD with q key and choose detach or kill"
    - "User can view help with ? key"
    - "selectedIndex stays valid when sessions are removed"
    - "HUD is focused on launch (not the main pane)"
    - "Main pane shows welcome screen on launch"
  artifacts:
    - path: "src/stores/appStore.ts"
      provides: "setSessions action with selectedIndex clamping"
      contains: "Math.min"
    - path: "src/services/tmuxService.ts"
      provides: "createHudLayout selects HUD pane and shows welcome"
      contains: "select-pane.*hudPane"
    - path: "src/components/WelcomePane.tsx"
      provides: "ASCII art welcome component for main pane"
      contains: "claude-terminal"
  key_links:
    - from: "src/stores/appStore.ts"
      to: "selectedIndex state"
      via: "setSessions clamps index"
      pattern: "selectedIndex.*Math\\.min"
    - from: "src/services/tmuxService.ts"
      to: "main pane"
      via: "echo command displays welcome"
      pattern: "send-keys.*Welcome"
---

<objective>
Fix selectedIndex bounds checking, add welcome screen on launch, and validate all v1.0 navigation patterns work in v2.0 tmux architecture.

Purpose: Phase 11 validates navigation and polishes the launch experience. The navigation code already exists (Phases 5, 9, 10). This plan:
1. Fixes the selectedIndex out-of-bounds bug
2. Focuses HUD on launch (instead of main pane)
3. Shows ASCII art welcome in main pane on startup
4. Validates all navigation through human testing

Output: Fixed appStore, polished launch experience, verified navigation in tmux context.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-navigation-integration/11-RESEARCH.md

# Key source files for navigation and startup
@src/app.tsx
@src/stores/appStore.ts
@src/hooks/useSessions.ts
@src/components/HudStrip.tsx
@src/services/tmuxService.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix selectedIndex bounds on session removal</name>
  <files>src/stores/appStore.ts</files>
  <action>
Update the `setSessions` action to clamp `selectedIndex` when the sessions array shrinks.

Current implementation (line 27):
```typescript
setSessions: (sessions) => set({ sessions }),
```

Change to:
```typescript
setSessions: (sessions) => set((state) => ({
  sessions,
  // Clamp selectedIndex to valid range when sessions change
  selectedIndex: Math.min(state.selectedIndex, Math.max(0, sessions.length - 1)),
})),
```

This ensures:
- If sessions.length = 0, selectedIndex becomes 0 (Math.max(0, -1) = 0)
- If sessions.length = 3 and selectedIndex = 5, selectedIndex becomes 2
- If sessions.length = 5 and selectedIndex = 2, selectedIndex stays 2

Note: The set() call with a function allows access to current state for the clamping logic.
  </action>
  <verify>
1. Run `npm run build` - should compile without errors
2. Run `npm run lint` - should pass
3. Read src/stores/appStore.ts and verify setSessions includes Math.min clamping logic
  </verify>
  <done>
setSessions action clamps selectedIndex to valid bounds when sessions array changes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Focus HUD on launch and show welcome in main pane</name>
  <files>src/services/tmuxService.ts</files>
  <action>
Modify `createHudLayout` in tmuxService.ts to:
1. Focus the HUD pane (not the main pane) after layout creation
2. Display ASCII art welcome message in the main pane

At the end of `createHudLayout`, replace the current line:
```typescript
// Select the main pane so it's ready for user interaction
await execAsync(`tmux select-pane -t ${mainPane.trim()}`);
```

With:
```typescript
// Display welcome message in main pane
const welcomeArt = `
╔═══════════════════════════════════════════════════════════════╗
║                                                               ║
║       ██████╗██╗      █████╗ ██╗   ██╗██████╗ ███████╗        ║
║      ██╔════╝██║     ██╔══██╗██║   ██║██╔══██╗██╔════╝        ║
║      ██║     ██║     ███████║██║   ██║██║  ██║█████╗          ║
║      ██║     ██║     ██╔══██║██║   ██║██║  ██║██╔══╝          ║
║      ╚██████╗███████╗██║  ██║╚██████╔╝██████╔╝███████╗        ║
║       ╚═════╝╚══════╝╚═╝  ╚═╝ ╚═════╝ ╚═════╝ ╚══════╝        ║
║                    ████████╗███████╗██████╗ ███╗   ███╗       ║
║                    ╚══██╔══╝██╔════╝██╔══██╗████╗ ████║       ║
║                       ██║   █████╗  ██████╔╝██╔████╔██║       ║
║                       ██║   ██╔══╝  ██╔══██╗██║╚██╔╝██║       ║
║                       ██║   ███████╗██║  ██║██║ ╚═╝ ██║       ║
║                       ╚═╝   ╚══════╝╚═╝  ╚═╝╚═╝     ╚═╝       ║
║                                                               ║
║          Your AI-powered terminal session manager             ║
║                                                               ║
║   Press 'n' in HUD to spawn a new Claude session              ║
║   Press '?' for help | 'q' to quit                            ║
║                                                               ║
╚═══════════════════════════════════════════════════════════════╝
`;

// Send welcome art to main pane (use cat with heredoc for proper display)
// First clear the pane, then display welcome
await execAsync(\`tmux send-keys -t \${mainPane.trim()} 'clear && cat << "WELCOME"\${welcomeArt}WELCOME' Enter\`);

// Select the HUD pane so user starts with focus on navigation
await execAsync(\`tmux select-pane -t \${hudPane.trim()}\`);
```

Note: The welcome art uses box-drawing characters which render well in most terminals. The `send-keys` approach uses cat with heredoc to display multi-line text properly in the shell.
  </action>
  <verify>
1. Run `npm run build` - should compile without errors
2. Start claude-terminal fresh (kill existing session first with `tmux kill-session -t claude-terminal`)
3. Run `claude-terminal` or `npm run dev`
4. Verify: HUD pane is focused (cursor in HUD strip)
5. Verify: Main pane shows ASCII art welcome message
  </verify>
  <done>
On launch, HUD is focused and main pane displays ASCII art welcome screen.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Validate all navigation paths</name>
  <what-built>
1. Fixed selectedIndex bounds checking
2. HUD focused on launch (instead of main pane)
3. Welcome ASCII art displayed in main pane
All navigation code from v1.0 (j/k, arrows, 1-9, Enter, q, ?) is already implemented in app.tsx. This checkpoint validates everything works correctly in the v2.0 tmux-integrated architecture.
  </what-built>
  <how-to-verify>
Start the HUD fresh and run through this validation checklist:

**Setup:**
1. Kill any existing session: `tmux kill-session -t claude-terminal 2>/dev/null`
2. Run `npm run dev` or `claude-terminal` to start fresh
3. Verify welcome screen appears and HUD is focused

**Launch Experience (NEW):**
- [ ] HUD pane is focused on launch (cursor in HUD strip, not main pane)
- [ ] Main pane shows ASCII art welcome with "CLAUDE TERM" branding
- [ ] Welcome message shows key hints (n for new, ? for help, q to quit)

**NAV-01: j/k and arrow navigation**
- [ ] Press j - selection moves right (or stays at end if at last session)
- [ ] Press k - selection moves left (or stays at start if at first session)
- [ ] Press Down arrow - same as j
- [ ] Press Up arrow - same as k
- [ ] Press Left arrow - moves selection left (same as k in horizontal tabs)
- [ ] Press Right arrow - moves selection right (same as j in horizontal tabs)
- [ ] Selection highlight (inverse video) is visible on current tab

**NAV-02: Quick-jump with 1-9**
- [ ] Press n to spawn 2-3 sessions first
- [ ] Press 1 - selects first session
- [ ] Press 2 - selects second session (if exists)
- [ ] Press a number higher than session count - ignored (no change)
- [ ] Press 0 - ignored (not a hotkey)

**NAV-03: Enter to switch session**
- [ ] Press Enter on a session - bottom pane shows that session, welcome disappears
- [ ] Tab shows active marker (underline)
- [ ] Press Ctrl+g or Ctrl+h to return to HUD focus

**NAV-04: q to quit**
- [ ] Press q - shows "Quit: [d]etach | [k]ill | [n/Esc] cancel" on line 2
- [ ] Press n or Esc - cancels, returns to normal HUD
- [ ] (Optional) Press d - detaches from tmux session, returns to shell
- [ ] (Optional) Press k - kills tmux session and all panes

**NAV-05: ? for help**
- [ ] Press ? - shows help line with key hints
- [ ] Press any key - dismisses help (does NOT also navigate)
- [ ] Help text shows: arrows, Enter, j/k, 1-9, q, ?

**Edge Cases:**
- [ ] With 0 sessions: j/k/arrows don't cause errors
- [ ] With 1 session: navigation stays at index 0
- [ ] Kill a Claude session (Ctrl+C in it) while HUD is running: selectedIndex stays valid, no crash
- [ ] Rapid key presses: no visual glitches or state corruption
  </how-to-verify>
  <resume-signal>Type "approved" if all navigation works correctly, or describe any issues found.</resume-signal>
</task>

</tasks>

<verification>
All navigation requirements verified:
- NAV-01: j/k and arrow navigation works with bounds clamping
- NAV-02: Quick-jump 1-9 works, out-of-range ignored
- NAV-03: Enter switches sessions (internal swap-pane, external select-pane)
- NAV-04: q shows detach/kill prompt, d/k/n/Esc work
- NAV-05: ? shows help, any key dismisses
- Edge case: selectedIndex stays valid when sessions removed
- Launch: HUD focused, welcome ASCII art in main pane
</verification>

<success_criteria>
1. `npm run build` passes
2. `npm run lint` passes
3. setSessions includes bounds checking for selectedIndex
4. HUD is focused on launch (not main pane)
5. Main pane shows ASCII art welcome on fresh start
6. Human verification of all 5 NAV requirements passes
7. No navigation crashes or unexpected behavior
</success_criteria>

<output>
After completion, create `.planning/phases/11-navigation-integration/11-01-SUMMARY.md`
</output>
