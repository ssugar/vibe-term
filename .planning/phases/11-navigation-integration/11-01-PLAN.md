---
phase: 11-navigation-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/stores/appStore.ts
autonomous: false

must_haves:
  truths:
    - "User can navigate sessions with j/k or arrow keys without going out of bounds"
    - "User can quick-jump to sessions 1-9 with number keys"
    - "User can switch to selected session with Enter key"
    - "User can quit HUD with q key and choose detach or kill"
    - "User can view help with ? key"
    - "selectedIndex stays valid when sessions are removed"
  artifacts:
    - path: "src/stores/appStore.ts"
      provides: "setSessions action with selectedIndex clamping"
      contains: "Math.min"
  key_links:
    - from: "src/stores/appStore.ts"
      to: "selectedIndex state"
      via: "setSessions clamps index"
      pattern: "selectedIndex.*Math\\.min"
---

<objective>
Fix selectedIndex bounds checking and validate all v1.0 navigation patterns work in v2.0 tmux architecture.

Purpose: Phase 11 is primarily a validation phase. The navigation code already exists and works (implemented in Phases 5, 9, 10). This plan fixes the one identified bug (selectedIndex out of bounds on session death) and then validates all navigation through human testing.

Output: Fixed appStore with bounds-checked selectedIndex, verified navigation in tmux context.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-navigation-integration/11-RESEARCH.md

# Key source files for navigation
@src/app.tsx
@src/stores/appStore.ts
@src/hooks/useSessions.ts
@src/components/HudStrip.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix selectedIndex bounds on session removal</name>
  <files>src/stores/appStore.ts</files>
  <action>
Update the `setSessions` action to clamp `selectedIndex` when the sessions array shrinks.

Current implementation (line 27):
```typescript
setSessions: (sessions) => set({ sessions }),
```

Change to:
```typescript
setSessions: (sessions) => set((state) => ({
  sessions,
  // Clamp selectedIndex to valid range when sessions change
  selectedIndex: Math.min(state.selectedIndex, Math.max(0, sessions.length - 1)),
})),
```

This ensures:
- If sessions.length = 0, selectedIndex becomes 0 (Math.max(0, -1) = 0)
- If sessions.length = 3 and selectedIndex = 5, selectedIndex becomes 2
- If sessions.length = 5 and selectedIndex = 2, selectedIndex stays 2

Note: The set() call with a function allows access to current state for the clamping logic.
  </action>
  <verify>
1. Run `npm run build` - should compile without errors
2. Run `npm run lint` - should pass
3. Read src/stores/appStore.ts and verify setSessions includes Math.min clamping logic
  </verify>
  <done>
setSessions action clamps selectedIndex to valid bounds when sessions array changes.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Validate all navigation paths</name>
  <what-built>
Fixed selectedIndex bounds checking. All navigation code from v1.0 (j/k, arrows, 1-9, Enter, q, ?) is already implemented in app.tsx. This checkpoint validates everything works correctly in the v2.0 tmux-integrated architecture.
  </what-built>
  <how-to-verify>
Start the HUD and run through this validation checklist:

**Setup:**
1. Run `npm run dev` or `claude-terminal` to start HUD
2. Ensure you have at least 2-3 Claude sessions running (use `n` to spawn if needed)

**NAV-01: j/k and arrow navigation**
- [ ] Press j - selection moves down (or stays at end if at last session)
- [ ] Press k - selection moves up (or stays at start if at first session)
- [ ] Press Down arrow - same as j
- [ ] Press Up arrow - same as k
- [ ] Press Left arrow - moves selection left (same as k in horizontal tabs)
- [ ] Press Right arrow - moves selection right (same as j in horizontal tabs)
- [ ] Selection highlight (inverse video) is visible on current tab

**NAV-02: Quick-jump with 1-9**
- [ ] Press 1 - selects first session
- [ ] Press 2 - selects second session (if exists)
- [ ] Press a number higher than session count - ignored (no change)
- [ ] Press 0 - ignored (not a hotkey)

**NAV-03: Enter to switch session**
- [ ] Press Enter on an internal session - bottom pane shows that session, tab shows active marker
- [ ] Press Enter on an external session (if any) - jumps to that tmux session
- [ ] Press Ctrl+g or Ctrl+h to return to HUD

**NAV-04: q to quit**
- [ ] Press q - shows "Quit: [d]etach | [k]ill | [n/Esc] cancel" on line 2
- [ ] Press n or Esc - cancels, returns to normal HUD
- [ ] (Optional) Press d - detaches from tmux session, returns to shell
- [ ] (Optional) Press k - kills tmux session and all panes

**NAV-05: ? for help**
- [ ] Press ? - shows help line with key hints
- [ ] Press any key - dismisses help (does NOT also navigate)
- [ ] Help text shows: arrows, Enter, j/k, 1-9, q, ?

**Edge Cases:**
- [ ] With 1 session: j/k/arrows don't cause errors, selection stays at 0
- [ ] Kill a Claude session (Ctrl+C in it) while HUD is running: selectedIndex stays valid
- [ ] Rapid key presses: no visual glitches or state corruption

**Expected behavior notes:**
- Navigation clamps at boundaries (doesn't wrap)
- Internal sessions use swap-pane (stay in claude-terminal)
- External sessions use select-pane (jump out of claude-terminal)
- Blocked sessions show red background, can be selected and entered
  </how-to-verify>
  <resume-signal>Type "approved" if all navigation works correctly, or describe any issues found.</resume-signal>
</task>

</tasks>

<verification>
All navigation requirements verified:
- NAV-01: j/k and arrow navigation works with bounds clamping
- NAV-02: Quick-jump 1-9 works, out-of-range ignored
- NAV-03: Enter switches sessions (internal swap-pane, external select-pane)
- NAV-04: q shows detach/kill prompt, d/k/n/Esc work
- NAV-05: ? shows help, any key dismisses
- Edge case: selectedIndex stays valid when sessions removed
</verification>

<success_criteria>
1. `npm run build` passes
2. `npm run lint` passes
3. setSessions includes bounds checking for selectedIndex
4. Human verification of all 5 NAV requirements passes
5. No navigation crashes or unexpected behavior
</success_criteria>

<output>
After completion, create `.planning/phases/11-navigation-integration/11-01-SUMMARY.md`
</output>
