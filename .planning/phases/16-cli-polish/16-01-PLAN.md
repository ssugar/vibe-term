---
phase: 16-cli-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/cli/json.ts
  - src/cli/suggestions.ts
  - src/cli/output.ts
autonomous: true

must_haves:
  truths:
    - "JSON envelope type is exported and can be imported by commands"
    - "Suggestion functions return appropriate suggestions based on command results"
    - "setJsonMode(true) prevents console.log output from output.ts functions"
    - "Errors and suggestions can be collected in JSON mode"
  artifacts:
    - path: "src/cli/json.ts"
      provides: "JSON output types and formatters"
      exports: ["JsonOutput", "JsonError", "JsonSuggestion", "createJsonOutput", "outputJson", "getVersion"]
    - path: "src/cli/suggestions.ts"
      provides: "Contextual suggestion logic per command"
      exports: ["getSetupSuggestion", "getAuditSuggestion", "getFixSuggestion", "SetupResult", "AuditResult", "FixResult"]
    - path: "src/cli/output.ts"
      provides: "Dual-mode output (human vs JSON)"
      exports: ["setJsonMode", "isJsonMode", "getCollectedErrors", "getCollectedSuggestions", "collectError"]
  key_links:
    - from: "src/cli/json.ts"
      to: "package.json"
      via: "getVersion reads version field"
      pattern: "readFileSync.*package\\.json"
    - from: "src/cli/output.ts"
      to: "src/cli/json.ts"
      via: "imports JsonError type for collected errors"
      pattern: "import.*JsonError.*from.*json"
---

<objective>
Create the JSON output infrastructure that enables all CLI commands to produce machine-readable output.

Purpose: Establishes the foundation for --json flag support across setup, audit, and fix commands. Creates consistent JSON envelope format, contextual suggestion logic, and dual-mode output helpers.

Output: Three new/enhanced modules (json.ts, suggestions.ts, output.ts) providing types, formatters, and dual-mode output functions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-cli-polish/16-CONTEXT.md
@.planning/phases/16-cli-polish/16-RESEARCH.md
@src/cli/output.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create JSON output module with types and formatters</name>
  <files>src/cli/json.ts</files>
  <action>
Create src/cli/json.ts with:

1. Type definitions:
   - `JsonError` interface with `category: string` and `message: string`
   - `JsonSuggestion` interface with `action: string`, `command: string`, `reason: string`
   - `JsonOutput<T>` interface with fields:
     - `success: boolean`
     - `data: T`
     - `errors: JsonError[]`
     - `suggestions: JsonSuggestion[]`
     - `meta: { timestamp: string, version: string, duration_ms: number, command: string }`

2. Helper function `getVersion()`:
   - Read version from package.json using `readFileSync` and `JSON.parse`
   - Cache the result (read once at module load)
   - Use `node:fs` and `node:path` with `import.meta.url` for path resolution

3. Factory function `createJsonOutput<T>(command, data, options)`:
   - `command`: string (e.g., "setup", "audit", "fix")
   - `data`: T (command-specific result data)
   - `options`: `{ success: boolean, errors?: JsonError[], suggestions?: JsonSuggestion[], startTime: bigint }`
   - Calculate `duration_ms` from `process.hrtime.bigint() - startTime`
   - Return complete `JsonOutput<T>` object

4. Output function `outputJson<T>(output: JsonOutput<T>)`:
   - Simply `console.log(JSON.stringify(output, null, 2))`

Use ESM imports with `node:` prefix for built-ins. Export all types and functions.
  </action>
  <verify>
TypeScript compiles without errors: `npx tsc --noEmit`
  </verify>
  <done>
json.ts exports JsonOutput, JsonError, JsonSuggestion types and createJsonOutput, outputJson, getVersion functions
  </done>
</task>

<task type="auto">
  <name>Task 2: Create suggestions module with command-specific logic</name>
  <files>src/cli/suggestions.ts</files>
  <action>
Create src/cli/suggestions.ts with:

1. Result type interfaces (used by commands and suggestion functions):
   ```typescript
   export interface SetupResult {
     installed: boolean;
     already_installed: boolean;
     hook_script_path?: string;
     settings_path?: string;
     backup_path?: string;
   }

   export interface AuditResult {
     scanned: number;
     pass: number;
     warn: number;
     fail: number;
     projects: Array<{
       path: string;
       status: 'pass' | 'warn' | 'fail';
       issues: string[];
     }>;
   }

   export interface FixResult {
     total: number;
     fixed: number;
     skipped: number;
     failed: number;
     projects: Array<{
       path: string;
       status: 'fixed' | 'skipped' | 'failed';
       backup_path?: string;
       error?: string;
     }>;
   }
   ```

2. Suggestion functions (import JsonSuggestion from './json.js'):

   `getSetupSuggestion(result: SetupResult): JsonSuggestion | null`:
   - If `result.installed` is true: return suggestion to run `vibe-term audit`
   - Otherwise return null

   `getAuditSuggestion(result: AuditResult): JsonSuggestion | null`:
   - If `result.warn > 0 || result.fail > 0`: return suggestion to run `vibe-term fix`
   - Include count in reason: "Found N warnings and M failures"
   - Otherwise return null

   `getFixSuggestion(result: FixResult, dryRun: boolean): JsonSuggestion | null`:
   - If `dryRun` is true: return suggestion to run `vibe-term fix --apply`
   - Else if `result.fixed > 0`: return suggestion to run `vibe-term audit`
   - Otherwise return null

Suggestion format per CONTEXT.md:
- action: "Run `vibe-term <command>` to <verb>"
- command: "vibe-term <command>"
- reason: contextual explanation
  </action>
  <verify>
TypeScript compiles without errors: `npx tsc --noEmit`
  </verify>
  <done>
suggestions.ts exports SetupResult, AuditResult, FixResult types and getSetupSuggestion, getAuditSuggestion, getFixSuggestion functions
  </done>
</task>

<task type="auto">
  <name>Task 3: Enhance output.ts for dual-mode output</name>
  <files>src/cli/output.ts</files>
  <action>
Modify src/cli/output.ts to add JSON mode support while preserving existing functionality:

1. Add imports at top:
   ```typescript
   import type { JsonError, JsonSuggestion } from './json.js';
   ```

2. Add module-level state:
   ```typescript
   let jsonMode = false;
   let collectedErrors: JsonError[] = [];
   let collectedSuggestions: JsonSuggestion[] = [];
   ```

3. Add mode control functions:
   ```typescript
   export function setJsonMode(enabled: boolean): void {
     jsonMode = enabled;
     collectedErrors = [];
     collectedSuggestions = [];
   }

   export function isJsonMode(): boolean {
     return jsonMode;
   }
   ```

4. Add error/suggestion collection functions:
   ```typescript
   export function collectError(message: string, category = 'GENERAL'): void {
     collectedErrors.push({ category, message });
   }

   export function collectSuggestion(suggestion: JsonSuggestion): void {
     collectedSuggestions.push(suggestion);
   }

   export function getCollectedErrors(): JsonError[] {
     return collectedErrors;
   }

   export function getCollectedSuggestions(): JsonSuggestion[] {
     return collectedSuggestions;
   }
   ```

5. Modify ALL existing output functions to check jsonMode:
   - `success()`: if (jsonMode) return; else existing logic
   - `error()`: if (jsonMode) { collectError(message); return; } else existing logic
   - `warning()`: if (jsonMode) return; else existing logic
   - `info()`: if (jsonMode) return; else existing logic

The color helper functions (green, red, yellow, cyan, dim, bold, filePath, timestamp, keyValue, heading) do NOT change - they return strings and don't print.

Keep all existing exports. Add new exports: setJsonMode, isJsonMode, collectError, collectSuggestion, getCollectedErrors, getCollectedSuggestions.
  </action>
  <verify>
TypeScript compiles without errors: `npx tsc --noEmit`
Test: Quick manual verification that imports resolve correctly
  </verify>
  <done>
output.ts supports dual-mode output with setJsonMode/isJsonMode and error/suggestion collection
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. TypeScript compilation succeeds:
   ```bash
   npx tsc --noEmit
   ```

2. All new exports are available:
   ```bash
   # Verify exports parse correctly
   npx tsx -e "import { JsonOutput, createJsonOutput, outputJson } from './src/cli/json.js'; console.log('json.ts OK')"
   npx tsx -e "import { getSetupSuggestion, SetupResult } from './src/cli/suggestions.js'; console.log('suggestions.ts OK')"
   npx tsx -e "import { setJsonMode, isJsonMode } from './src/cli/output.js'; console.log('output.ts OK')"
   ```

3. getVersion returns package version:
   ```bash
   npx tsx -e "import { getVersion } from './src/cli/json.js'; console.log(getVersion())"
   # Should output: 1.0.0
   ```
</verification>

<success_criteria>
- [ ] json.ts created with all types and functions
- [ ] suggestions.ts created with result types and suggestion functions
- [ ] output.ts enhanced with dual-mode support
- [ ] TypeScript compiles without errors
- [ ] All exports are importable
- [ ] getVersion() returns "1.0.0"
</success_criteria>

<output>
After completion, create `.planning/phases/16-cli-polish/16-01-SUMMARY.md`
</output>
