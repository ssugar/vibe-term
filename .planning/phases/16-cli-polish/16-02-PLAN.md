---
phase: 16-cli-polish
plan: 02
type: execute
wave: 2
depends_on: ["16-01"]
files_modified:
  - src/cli.tsx
  - src/cli/setup.ts
  - src/cli/audit.ts
  - src/cli/fix.ts
autonomous: true

must_haves:
  truths:
    - "vibe-term setup --json outputs valid JSON envelope to stdout"
    - "vibe-term audit --json outputs valid JSON with projects array"
    - "vibe-term fix --json outputs valid JSON with fix results"
    - "Human-mode setup shows inline suggestion to run audit"
    - "Human-mode audit with issues shows inline suggestion to run fix"
    - "Human-mode fix after apply shows inline suggestion to run audit"
    - "--json mode suppresses all human-readable output"
    - "Exit codes remain consistent regardless of output mode"
  artifacts:
    - path: "src/cli.tsx"
      provides: "--json flag in CLI router"
      contains: "json: { type: 'boolean'"
    - path: "src/cli/setup.ts"
      provides: "JSON-aware setup command"
      contains: ["setJsonMode", "createJsonOutput", "outputJson"]
    - path: "src/cli/audit.ts"
      provides: "JSON-aware audit command"
      contains: ["setJsonMode", "createJsonOutput", "outputJson"]
    - path: "src/cli/fix.ts"
      provides: "JSON-aware fix command"
      contains: ["setJsonMode", "createJsonOutput", "outputJson"]
  key_links:
    - from: "src/cli.tsx"
      to: "src/cli/setup.ts"
      via: "passes json flag to runSetup"
      pattern: "json: cli\\.flags\\.json"
    - from: "src/cli/setup.ts"
      to: "src/cli/json.ts"
      via: "imports JSON output functions"
      pattern: "import.*createJsonOutput.*from.*json"
    - from: "src/cli/audit.ts"
      to: "src/cli/suggestions.ts"
      via: "imports getAuditSuggestion"
      pattern: "import.*getAuditSuggestion.*from.*suggestions"
---

<objective>
Wire JSON output mode and contextual suggestions into all CLI commands.

Purpose: Complete CLI-03 (--json flag support) and CLI-04 (action suggestions) requirements by updating the CLI router and all three commands (setup, audit, fix) to produce JSON output when requested and show contextual suggestions in human mode.

Output: All CLI commands support --json flag with consistent envelope output, and human-mode commands show appropriate next-step suggestions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-cli-polish/16-CONTEXT.md
@.planning/phases/16-cli-polish/16-RESEARCH.md
@.planning/phases/16-cli-polish/16-01-SUMMARY.md
@src/cli.tsx
@src/cli/setup.ts
@src/cli/audit.ts
@src/cli/fix.ts
@src/cli/json.ts
@src/cli/suggestions.ts
@src/cli/output.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add --json flag to CLI router</name>
  <files>src/cli.tsx</files>
  <action>
Modify src/cli.tsx to add --json flag support:

1. Add to the meow help text:
   ```
   --json         Output machine-readable JSON
   ```

2. Add to the flags configuration:
   ```typescript
   json: {
     type: 'boolean',
     default: false,
   },
   ```

3. Pass json flag to each command call:
   - setup: `{ yes: cli.flags.yes, verbose: cli.flags.verbose, json: cli.flags.json }`
   - audit: `{ failOnly: cli.flags.failOnly, verbose: cli.flags.verbose, pattern: cli.input[1], json: cli.flags.json }`
   - fix: `{ apply: cli.flags.apply, yes: cli.flags.yes, verbose: cli.flags.verbose, pattern: cli.input[1], json: cli.flags.json }`
  </action>
  <verify>
`npx tsx src/cli.tsx --help` shows --json in Options section
  </verify>
  <done>
CLI router accepts --json flag and passes it to all commands
  </done>
</task>

<task type="auto">
  <name>Task 2: Update setup.ts for JSON output and suggestions</name>
  <files>src/cli/setup.ts</files>
  <action>
Modify src/cli/setup.ts to support JSON output mode:

1. Add imports:
   ```typescript
   import { createJsonOutput, outputJson } from './json.js';
   import { getSetupSuggestion, type SetupResult } from './suggestions.js';
   import { setJsonMode, isJsonMode, getCollectedErrors, cyan } from './output.js';
   ```

2. Update SetupOptions interface:
   ```typescript
   interface SetupOptions {
     yes: boolean;
     verbose: boolean;
     json: boolean;
   }
   ```

3. Update runSetup function:
   - At start, capture `startTime = process.hrtime.bigint()` and call `setJsonMode(options.json)`
   - Create a result object to track outcomes:
     ```typescript
     const result: SetupResult = {
       installed: false,
       already_installed: false,
     };
     ```
   - Populate result fields as setup progresses:
     - When already installed: `result.already_installed = true`
     - When installed: `result.installed = true`, plus `result.hook_script_path`, `result.settings_path`, `result.backup_path`
   - For error cases in JSON mode: use `collectError()` instead of direct error() calls, then output JSON and return

4. Update confirm() to handle JSON mode:
   - If `options.json && !options.yes`: fail with error "Confirmation required but --json mode is non-interactive. Use --yes to skip confirmation."
   - If `options.json && options.yes`: return true (auto-confirm)
   - Pass options to confirm() calls

5. At end of runSetup, output based on mode:
   ```typescript
   if (isJsonMode()) {
     const suggestion = getSetupSuggestion(result);
     const suggestions = suggestion ? [suggestion] : [];
     const output = createJsonOutput('setup', result, {
       success: result.installed || result.already_installed,
       errors: getCollectedErrors(),
       suggestions,
       startTime,
     });
     outputJson(output);
   } else {
     // Existing human-readable output
     if (result.installed) {
       console.log('');
       success('vibe-term hooks installed successfully!');
       const suggestion = getSetupSuggestion(result);
       if (suggestion) {
         console.log(`${cyan('->')} ${suggestion.action}`);
       }
     }
   }
   ```

6. Return appropriate exit code (unchanged logic, but set before JSON output).

Important: In JSON mode, ALL output goes through the JSON envelope. No console.log except the final outputJson call.
  </action>
  <verify>
```bash
# Test human mode
npx tsx src/cli.tsx setup --yes 2>&1 | head -5

# Test JSON mode (should output valid JSON)
npx tsx src/cli.tsx setup --yes --json | head -20
```
  </verify>
  <done>
setup command outputs JSON when --json flag is passed and shows suggestion in human mode
  </done>
</task>

<task type="auto">
  <name>Task 3: Update audit.ts for JSON output and suggestions</name>
  <files>src/cli/audit.ts</files>
  <action>
Modify src/cli/audit.ts to support JSON output mode:

1. Add imports:
   ```typescript
   import { createJsonOutput, outputJson } from './json.js';
   import { getAuditSuggestion, type AuditResult } from './suggestions.js';
   import { setJsonMode, isJsonMode, getCollectedErrors, collectError, cyan } from './output.js';
   ```

2. Update AuditOptions interface:
   ```typescript
   export interface AuditOptions {
     failOnly: boolean;
     verbose: boolean;
     pattern?: string;
     json: boolean;
   }
   ```

3. Update runAudit function:
   - At start, capture `startTime = process.hrtime.bigint()` and call `setJsonMode(options.json)`
   - Build result object as audit progresses:
     ```typescript
     const result: AuditResult = {
       scanned: 0,
       pass: 0,
       warn: 0,
       fail: 0,
       projects: [],
     };
     ```
   - Populate result.projects array from classification results
   - Calculate counts: result.scanned, result.pass, result.warn, result.fail

4. For error cases (settings not found, hooks not installed):
   - In JSON mode: collectError() with appropriate category, output JSON with empty result, return error code
   - In human mode: existing error() calls

5. At end, output based on mode:
   ```typescript
   if (isJsonMode()) {
     const suggestion = getAuditSuggestion(result);
     const suggestions = suggestion ? [suggestion] : [];
     const output = createJsonOutput('audit', result, {
       success: result.fail === 0,
       errors: getCollectedErrors(),
       suggestions,
       startTime,
     });
     outputJson(output);
   } else {
     // Existing display functions
     displayTable(displayResults);
     if (verbose) {
       displayVerboseDetails(results);
     }
     displaySummary(results);

     // Add suggestion if issues found
     const suggestion = getAuditSuggestion(result);
     if (suggestion) {
       console.log(`${cyan('->')} ${suggestion.action}`);
     }
   }
   ```

6. Wrap display functions in `if (!isJsonMode())` checks, or move them inside the else block.

Important: In JSON mode, do NOT call displayTable, displayVerboseDetails, displaySummary.
  </action>
  <verify>
```bash
# Test human mode
npx tsx src/cli.tsx audit 2>&1 | tail -10

# Test JSON mode
npx tsx src/cli.tsx audit --json | head -30
```
  </verify>
  <done>
audit command outputs JSON when --json flag is passed and shows suggestion in human mode when issues found
  </done>
</task>

<task type="auto">
  <name>Task 4: Update fix.ts for JSON output and suggestions</name>
  <files>src/cli/fix.ts</files>
  <action>
Modify src/cli/fix.ts to support JSON output mode:

1. Add imports:
   ```typescript
   import { createJsonOutput, outputJson } from './json.js';
   import { getFixSuggestion, type FixResult as SuggestionFixResult } from './suggestions.js';
   import { setJsonMode, isJsonMode, getCollectedErrors, collectError, cyan } from './output.js';
   ```

2. Update FixOptions interface:
   ```typescript
   export interface FixOptions {
     apply: boolean;
     yes: boolean;
     verbose: boolean;
     pattern?: string;
     json: boolean;
   }
   ```

3. Update runFix function:
   - At start, capture `startTime = process.hrtime.bigint()` and call `setJsonMode(options.json)`
   - Create result tracking object:
     ```typescript
     const resultData: SuggestionFixResult = {
       total: 0,
       fixed: 0,
       skipped: 0,
       failed: 0,
       projects: [],
     };
     ```

4. Update confirmProject to handle JSON mode:
   - If JSON mode: skip prompts entirely (per CONTEXT.md decision, JSON mode requires --yes for confirmation)
   - Check at runFix level: if `options.json && !options.yes && options.apply`: fail with error about needing --yes

5. Track results as fixes are applied:
   - Increment resultData.total, fixed, skipped, failed
   - Populate resultData.projects array with each project's outcome

6. For dry-run mode, still build the result but with status 'skipped' for all:
   - resultData.projects entries get status: 'skipped' in dry-run

7. At end, output based on mode:
   ```typescript
   if (isJsonMode()) {
     const suggestion = getFixSuggestion(resultData, !options.apply);
     const suggestions = suggestion ? [suggestion] : [];
     const output = createJsonOutput('fix', resultData, {
       success: resultData.failed === 0,
       errors: getCollectedErrors(),
       suggestions,
       startTime,
     });
     outputJson(output);
   } else {
     // Existing summary output
     info(`Fixed ${successCount} project(s), ${failCount} failed.`);

     // Add suggestion
     const suggestion = getFixSuggestion(resultData, !options.apply);
     if (suggestion) {
       console.log(`${cyan('->')} ${suggestion.action}`);
     }
   }
   ```

8. Wrap display functions (displaySummaryTable, displayBeforeAfter) in `if (!isJsonMode())` checks.

Important:
- In JSON mode with --apply but without --yes, fail with clear error (don't silently skip confirmations)
- In dry-run mode, resultData should still be populated for JSON output
  </action>
  <verify>
```bash
# Test human mode dry-run
npx tsx src/cli.tsx fix 2>&1 | tail -10

# Test JSON mode dry-run
npx tsx src/cli.tsx fix --json | head -30

# Test JSON mode with apply (needs --yes)
npx tsx src/cli.tsx fix --apply --yes --json | head -30
```
  </verify>
  <done>
fix command outputs JSON when --json flag is passed and shows appropriate suggestions based on dry-run vs apply mode
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. TypeScript compilation succeeds:
   ```bash
   npx tsc --noEmit
   ```

2. --json flag appears in help:
   ```bash
   npx tsx src/cli.tsx --help | grep json
   ```

3. JSON output is valid for each command:
   ```bash
   # Setup (may fail if already installed, but should output valid JSON)
   npx tsx src/cli.tsx setup --yes --json 2>/dev/null | python3 -m json.tool > /dev/null && echo "setup JSON valid"

   # Audit
   npx tsx src/cli.tsx audit --json 2>/dev/null | python3 -m json.tool > /dev/null && echo "audit JSON valid"

   # Fix
   npx tsx src/cli.tsx fix --json 2>/dev/null | python3 -m json.tool > /dev/null && echo "fix JSON valid"
   ```

4. JSON output has correct structure (check for required fields):
   ```bash
   npx tsx src/cli.tsx audit --json | grep -q '"success"' && echo "has success"
   npx tsx src/cli.tsx audit --json | grep -q '"data"' && echo "has data"
   npx tsx src/cli.tsx audit --json | grep -q '"errors"' && echo "has errors"
   npx tsx src/cli.tsx audit --json | grep -q '"suggestions"' && echo "has suggestions"
   npx tsx src/cli.tsx audit --json | grep -q '"meta"' && echo "has meta"
   ```

5. Human mode shows suggestions (when applicable):
   ```bash
   # After setup, should suggest audit
   npx tsx src/cli.tsx setup --yes 2>&1 | grep -i "audit"
   ```
</verification>

<success_criteria>
- [ ] --json flag added to CLI router and passed to all commands
- [ ] setup.ts produces valid JSON output with --json flag
- [ ] audit.ts produces valid JSON output with --json flag
- [ ] fix.ts produces valid JSON output with --json flag
- [ ] Human-mode setup shows suggestion to run audit
- [ ] Human-mode audit with issues shows suggestion to run fix
- [ ] Human-mode fix shows appropriate suggestion based on dry-run vs apply
- [ ] JSON mode suppresses all human-readable console output
- [ ] Exit codes remain consistent in both modes
- [ ] TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/16-cli-polish/16-02-SUMMARY.md`
</output>
