---
phase: 08-hud-strip-ui
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - src/components/TabStrip.tsx
autonomous: true

must_haves:
  truths:
    - "Sessions display as horizontal tabs in a single line"
    - "Blocked sessions are always visible (pinned) regardless of scroll position"
    - "Arrow indicators show when tabs overflow and scrolling is available"
    - "Scroll offset adjusts automatically to keep selected tab visible"
  artifacts:
    - path: "src/components/TabStrip.tsx"
      provides: "Horizontal tab bar with scroll and blocked pinning"
      exports: ["TabStrip"]
  key_links:
    - from: "src/components/TabStrip.tsx"
      to: "src/components/Tab.tsx"
      via: "Tab component import"
      pattern: "import.*Tab.*from"
    - from: "src/components/TabStrip.tsx"
      to: "src/hooks/useTerminalWidth.ts"
      via: "useTerminalWidth hook"
      pattern: "useTerminalWidth"
    - from: "src/components/TabStrip.tsx"
      to: "src/stores/appStore.ts"
      via: "sessions and selectedIndex from store"
      pattern: "useAppStore"
---

<objective>
Create the TabStrip component that renders sessions as horizontal tabs with overflow handling, blocked session pinning, and scroll indicators.

Purpose: This is the core horizontal layout component that replaces the vertical SessionList.
Output: TabStrip component ready to be integrated into the app.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/08-hud-strip-ui/08-CONTEXT.md
@.planning/phases/08-hud-strip-ui/08-RESEARCH.md
@.planning/phases/08-hud-strip-ui/08-01-SUMMARY.md

@src/components/Tab.tsx
@src/hooks/useTerminalWidth.ts
@src/stores/appStore.ts
@src/components/EmptyState.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TabStrip component</name>
  <files>src/components/TabStrip.tsx</files>
  <action>
Create the TabStrip component that renders sessions horizontally with scroll and overflow handling.

Implementation structure:

1. **Imports and setup:**
   - Import Box, Text from ink
   - Import figures from figures (for arrow symbols)
   - Import Tab from ./Tab.js
   - Import useTerminalWidth from ../hooks/useTerminalWidth.js
   - Import useAppStore from ../stores/appStore.js
   - Import EmptyState from ./EmptyState.js

2. **State management:**
   - Get sessions and selectedIndex from useAppStore (selective subscriptions)
   - Get terminalWidth from useTerminalWidth()
   - Local state: scrollOffset (useState, default 0)

3. **Tab width calculation:**
   Tab format: `[index:name status context%]`
   - Calculate per-tab width: 1 (bracket) + indexWidth + 1 (:) + nameWidth + 1 (space) + 2 (emoji) + 1 (space) + 4 (pct) + 1 (bracket) = ~12 + nameWidth
   - Use maxNameWidth of 20 for planning
   - Add 2 for double-space separator between tabs
   - Approximate per-tab: ~34 chars including separator

4. **Blocked session pinning (CRITICAL per CONTEXT.md):**
   - Separate blocked sessions: `sessions.filter(s => s.status === 'blocked')`
   - Separate normal sessions: `sessions.filter(s => s.status !== 'blocked')`
   - Blocked sessions always rendered first (leftmost), not affected by scroll
   - Calculate space used by blocked tabs
   - Remaining space for normal (scrollable) tabs

5. **Visible tab calculation:**
   - reservedWidth = arrow indicators (3 chars each side if needed) + blocked tabs width
   - availableWidth = terminalWidth - reservedWidth
   - Calculate how many normal tabs fit in availableWidth
   - Apply scrollOffset to normal sessions array

6. **Scroll offset auto-adjustment (keep selected visible):**
   - useEffect that watches selectedIndex
   - If selected is a blocked session, no scroll adjustment needed
   - If selected is a normal session:
     - Find its position in the normalSessions array
     - If position < scrollOffset, set scrollOffset = position
     - If position >= scrollOffset + visibleCount, set scrollOffset = position - visibleCount + 1

7. **Arrow indicators:**
   - showLeftArrow: scrollOffset > 0
   - showRightArrow: scrollOffset + visibleNormalCount < normalSessions.length
   - Use figures.arrowLeft and figures.arrowRight from figures package
   - Render dimColor for subtle appearance

8. **Empty state:**
   - If sessions.length === 0, return EmptyState component

9. **Render structure:**
```tsx
<Box flexDirection="row">
  {showLeftArrow && <Text dimColor>{figures.arrowLeft} </Text>}
  {blockedSessions.map((session, idx) => (
    <Tab key={session.id} session={session} index={originalIndex} isSelected={...} />
  ))}
  {visibleNormalSessions.map((session, idx) => (
    <Tab key={session.id} session={session} index={originalIndex} isSelected={...} />
  ))}
  {showRightArrow && <Text dimColor> {figures.arrowRight}</Text>}
</Box>
```

10. **Index preservation:**
    - Tab's `index` prop should be the original 1-based index in the full sessions array
    - This ensures hotkeys 1-9 still work correctly

11. **Tab separation:**
    - Add double space between tabs per CONTEXT.md
    - Can be done with marginRight={2} on Tab wrapper or explicit Text spacer

IMPORTANT: Handle edge cases:
- Terminal width < 60: Show warning or simplified view
- Single blocked session: Should always be visible
- All sessions blocked: All visible, no scroll needed
- No blocked sessions: All normal tabs scrollable
  </action>
  <verify>
File exists at src/components/TabStrip.tsx
TypeScript compiles without errors: `npm run build`
Component exports TabStrip function
  </verify>
  <done>
TabStrip component renders sessions horizontally, pins blocked sessions, shows scroll arrows when needed, and auto-scrolls to keep selected tab visible.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add tab width calculation helper</name>
  <files>src/components/TabStrip.tsx</files>
  <action>
Add a helper function within TabStrip.tsx to calculate individual tab widths accurately.

This is needed because:
- Different sessions have different name lengths
- Index numbers grow (1 vs 10 is different width)
- Emoji are double-width in terminals

Helper function:
```typescript
function calculateTabWidth(session: Session, index: number, maxNameWidth: number): number {
  // Get display name (last directory from path)
  const projectName = session.projectPath.split('/').pop() || session.projectPath;

  // Truncated name length
  const nameLen = Math.min(projectName.length, maxNameWidth);

  // Index width (1-9 = 1 char, 10+ = 2 chars)
  const indexWidth = String(index).length;

  // Tab format: [index:name emoji pct]
  // [     = 1 char
  // index = indexWidth chars
  // :     = 1 char
  // name  = nameLen chars
  // space = 1 char
  // emoji = 2 chars (double-width)
  // space = 1 char
  // pct   = 4 chars ("100%")
  // ]     = 1 char
  // separator = 2 chars (double space after tab)

  return 1 + indexWidth + 1 + nameLen + 1 + 2 + 1 + 4 + 1 + 2;
}
```

Use this helper in the visible tab calculation to get accurate width estimates.

Note: This refinement ensures the overflow calculation is precise rather than using fixed estimates.
  </action>
  <verify>
Build succeeds: `npm run build`
grep -q "calculateTabWidth" src/components/TabStrip.tsx
  </verify>
  <done>
Tab width calculation accounts for variable name lengths, index widths, and emoji double-width.
  </done>
</task>

</tasks>

<verification>
```bash
# Build succeeds
npm run build

# File exists with correct exports
ls src/components/TabStrip.tsx
grep -q "export function TabStrip" src/components/TabStrip.tsx

# Key implementations present
grep -q "useTerminalWidth" src/components/TabStrip.tsx
grep -q "scrollOffset" src/components/TabStrip.tsx
grep -q "blocked" src/components/TabStrip.tsx
grep -q "arrowLeft\|arrowRight" src/components/TabStrip.tsx
```
</verification>

<success_criteria>
- TabStrip component created and exports correctly
- Blocked sessions are pinned (always visible)
- Scroll arrows appear when tabs overflow
- Selected tab auto-scrolls into view
- Tab widths calculated accurately
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/08-hud-strip-ui/08-02-SUMMARY.md`
</output>
