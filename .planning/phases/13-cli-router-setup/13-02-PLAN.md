---
phase: 13-cli-router-setup
plan: 02
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - src/cli.tsx
  - src/cli/setup.ts
autonomous: true

must_haves:
  truths:
    - "Running 'vibe-term setup' installs hooks to ~/.claude/settings.json"
    - "Running setup creates backup before modifying settings"
    - "Running setup multiple times is idempotent (shows 'already installed' message)"
    - "Setup displays colored success/failure output showing what files changed"
    - "Setup supports --yes flag to skip confirmation prompt"
    - "Running 'vibe-term' without subcommand launches TUI as before"
  artifacts:
    - path: "src/cli/setup.ts"
      provides: "Setup command implementation"
      exports: ["runSetup", "EXIT_CODES"]
    - path: "src/cli.tsx"
      provides: "CLI entry point with command routing"
      contains: "cli.input[0] === 'setup'"
  key_links:
    - from: "src/cli.tsx"
      to: "src/cli/setup.ts"
      via: "dynamic import and runSetup call"
      pattern: "import.*setup\\.js.*runSetup"
    - from: "src/cli/setup.ts"
      to: "src/services/hookMerger.ts"
      via: "imports isVibeTermInstalled, mergeHooks"
      pattern: "import.*hookMerger"
    - from: "src/cli/setup.ts"
      to: "src/services/settingsService.ts"
      via: "imports read/write/backup settings"
      pattern: "import.*settingsService"
---

<objective>
Implement CLI command routing and the setup command for installing global hooks.

Purpose: Users need a single command (`vibe-term setup`) to install hooks to ~/.claude/settings.json with proper backup, idempotency, and feedback. The CLI router dispatches between setup and the existing TUI.

Output: Updated `src/cli.tsx` with command routing, new `src/cli/setup.ts` with full setup implementation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-cli-router-setup/13-CONTEXT.md
@.planning/phases/13-cli-router-setup/13-RESEARCH.md
@src/cli.tsx
@src/cli/output.ts
@src/services/settingsService.ts
@src/services/vibeTermDirService.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create setup command</name>
  <files>src/cli/setup.ts</files>
  <action>
Create src/cli/setup.ts with the setup command implementation:

1. Imports:
   - createInterface from 'readline/promises'
   - stdin, stdout from 'process'
   - All functions from './output.js' (success, error, warning, info, filePath, cyan, heading)
   - From settingsService.js: readClaudeSettings, writeClaudeSettings, settingsFileExists, getSettingsPath
   - From vibeTermDirService.js: installHookScript, getVibeTermPath
   - From hookMerger.js: isVibeTermInstalled, mergeHooks

2. Export EXIT_CODES constant:
   ```typescript
   export const EXIT_CODES = {
     SUCCESS: 0,
     ERROR: 1,
     USER_ABORT: 2,
   } as const;
   ```

3. Interface SetupOptions { yes: boolean; verbose: boolean; }

4. async function confirm(message: string): Promise<boolean>
   - If !stdin.isTTY, return true (skip prompt in CI/piped input)
   - Create readline interface
   - Use try/finally to ensure rl.close()
   - Ask question with "[Y/n]" suffix
   - Return true if answer is empty (Enter) or matches /^y(es)?$/i

5. Export async function runSetup(options: SetupOptions): Promise<number>
   Full flow per CONTEXT.md:

   Step 1: Check settings.json exists
   - If not, error("Settings file not found. Run Claude Code first to create it.")
   - info() showing expected path
   - Return EXIT_CODES.ERROR

   Step 2: Read current settings
   - try/catch readClaudeSettings()
   - On error, show message and return EXIT_CODES.ERROR

   Step 3: Check if already installed
   - If isVibeTermInstalled(settings):
     - success("Hooks already installed")
     - Return EXIT_CODES.SUCCESS

   Step 4: Show preview in verbose mode
   - If verbose:
     - console.log(heading("Changes to be made:"))
     - Show files that will be modified/created with cyan color

   Step 5: Confirm (unless --yes)
   - If !yes:
     - proceed = await confirm("This will modify ~/.claude/settings.json. Continue?")
     - If !proceed: warning("Setup cancelled"), return EXIT_CODES.USER_ABORT

   Step 6: Install hook script
   - try/catch installHookScript()
   - success() showing path created
   - On error, show message and return EXIT_CODES.ERROR

   Step 7: Merge hooks and write settings
   - merged = mergeHooks(settings)
   - try/catch writeClaudeSettings(merged, { backup: true })
   - On backup success, show backup path
   - success() showing modified file
   - On error: error("Cannot create backup. Aborting to protect existing settings.")
   - Return EXIT_CODES.ERROR on failure

   Step 8: Success message
   - console.log('') for spacing
   - success("vibe-term hooks installed successfully!")
   - info("Next step: Run `vibe-term audit` to verify installation")

   Return EXIT_CODES.SUCCESS
  </action>
  <verify>
Run: `npx tsc --noEmit`
Should compile without errors.
Verify setup.ts has runSetup and EXIT_CODES exports.
  </verify>
  <done>
setup.ts created with full setup flow.
Handles all error cases per CONTEXT.md.
Exports runSetup and EXIT_CODES.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add CLI router to entry point</name>
  <files>src/cli.tsx</files>
  <action>
Modify src/cli.tsx to add command routing:

1. Update meow help text to include setup command:
   ```
   Usage
     $ vibe-term           Launch TUI (default)
     $ vibe-term setup     Install global hooks

   Commands
     setup     Install hooks to ~/.claude/settings.json

   Options
     --refresh, -r  Refresh interval in seconds (default: 2)
     --yes          Skip confirmation prompts (setup only)
     --verbose, -v  Show detailed output (setup only)
   ```

2. Add flags for setup command to meow options:
   ```typescript
   flags: {
     refresh: { type: 'number', shortFlag: 'r', default: 2 },
     yes: { type: 'boolean', default: false },
     verbose: { type: 'boolean', shortFlag: 'v', default: false },
   },
   ```

3. After meow initialization, before ensureTmuxEnvironment():
   ```typescript
   // Route based on first positional argument
   const command = cli.input[0];

   if (command === 'setup') {
     const { runSetup } = await import('./cli/setup.js');
     const exitCode = await runSetup({
       yes: cli.flags.yes,
       verbose: cli.flags.verbose,
     });
     process.exit(exitCode);
   }

   // Default: proceed to TUI initialization
   ```

4. Keep all existing TUI initialization code unchanged after the router.

Note: The router MUST come before ensureTmuxEnvironment() because setup should NOT require tmux.
  </action>
  <verify>
Run: `npx tsc --noEmit` - should pass

Manual test commands:
1. `node dist/cli.js setup --help` - should show help with setup command
2. `node dist/cli.js setup --yes` - should attempt setup (may fail if settings missing, that's OK)
3. `node dist/cli.js` - should still launch TUI (requires tmux)
  </verify>
  <done>
cli.tsx routes to setup command when `vibe-term setup` is run.
TUI still launches for `vibe-term` without arguments.
--yes and --verbose flags available for setup.
  </done>
</task>

<task type="auto">
  <name>Task 3: Build and functional test</name>
  <files></files>
  <action>
Build the project and run functional tests:

1. Run TypeScript compilation:
   `npm run build`

2. Test setup command help:
   `node dist/cli.js --help`
   Should show setup command in usage.

3. Test setup with --yes flag (to skip prompt):
   If ~/.claude/settings.json exists:
   - `node dist/cli.js setup --yes`
   - Should either install hooks or show "already installed"

   If settings.json doesn't exist:
   - Should show "Settings file not found" error

4. Test idempotency:
   - Run setup twice with --yes
   - Second run should say "Hooks already installed"

5. Verify backup was created:
   `ls -la ~/.claude/settings.json.vibe-term-backup.*`
   Should show timestamped backup file.

6. Verify hook script installed:
   `ls -la ~/.vibe-term/status-hook.sh`
   Should be executable.

7. Quick TUI smoke test (if in tmux):
   `node dist/cli.js`
   Should launch TUI as before.
  </action>
  <verify>
- npm run build succeeds
- setup --help shows command
- setup --yes either installs or shows "already installed"
- Running setup twice is idempotent
- Backup file exists after first install
- Hook script exists and is executable
  </verify>
  <done>
Build passes.
Setup command works end-to-end.
Idempotency verified.
Backup created on install.
TUI still works for default command.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes
2. `vibe-term setup --yes` installs hooks or shows "already installed"
3. `vibe-term setup --yes` run twice shows "already installed" on second run
4. Backup file created at ~/.claude/settings.json.vibe-term-backup.TIMESTAMP
5. Hook script at ~/.vibe-term/status-hook.sh is executable
6. `vibe-term` without arguments still launches TUI
7. Exit codes: 0 for success, 1 for error, 2 for user abort
</verification>

<success_criteria>
- User can run `vibe-term setup` to install hooks
- Setup creates backup before modifying settings
- Setup is idempotent (safe to run multiple times)
- Setup shows colored output with file paths
- --yes flag skips confirmation prompt
- Default `vibe-term` command still launches TUI
</success_criteria>

<output>
After completion, create `.planning/phases/13-cli-router-setup/13-02-SUMMARY.md`
</output>
