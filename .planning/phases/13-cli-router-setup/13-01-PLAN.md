---
phase: 13-cli-router-setup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/services/hookMerger.ts
autonomous: true

must_haves:
  truths:
    - "isVibeTermInstalled returns true when settings contain vibe-term hook path"
    - "isVibeTermInstalled returns false for empty settings or other tools' hooks"
    - "mergeHooks adds vibe-term hooks to all required events without clobbering existing hooks"
    - "mergeHooks adds matcher: '*' to tool events (PreToolUse, PostToolUse, PostToolUseFailure)"
  artifacts:
    - path: "src/services/hookMerger.ts"
      provides: "Hook installation detection and intelligent merging"
      exports: ["isVibeTermInstalled", "mergeHooks", "HOOK_EVENTS", "VIBE_TERM_HOOK_SCRIPT"]
  key_links:
    - from: "src/services/hookMerger.ts"
      to: "src/services/settingsService.ts"
      via: "imports ClaudeSettings, HookConfig types"
      pattern: "import.*ClaudeSettings.*settingsService"
---

<objective>
Create the hook merger service for detecting existing vibe-term installation and intelligently merging hooks into Claude settings.

Purpose: The setup command needs to check if hooks are already installed (idempotency) and merge vibe-term's hooks alongside any existing hooks from other tools without clobbering them.

Output: `src/services/hookMerger.ts` with `isVibeTermInstalled()`, `mergeHooks()`, and supporting utilities.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-cli-router-setup/13-CONTEXT.md
@.planning/phases/13-cli-router-setup/13-RESEARCH.md
@src/services/settingsService.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create hookMerger service</name>
  <files>src/services/hookMerger.ts</files>
  <action>
Create src/services/hookMerger.ts with:

1. Import ClaudeSettings, HookConfig from settingsService.js

2. Export constant VIBE_TERM_HOOK_SCRIPT = '~/.vibe-term/status-hook.sh'
   - Keep ~ in path - Claude expands it at runtime

3. Export constant HOOK_EVENTS array with all 11 hook events:
   - SessionStart, UserPromptSubmit, PermissionRequest
   - PreToolUse, PostToolUse, PostToolUseFailure
   - Stop, SessionEnd
   - SubagentStart, SubagentStop, Notification

4. Export function isVibeTermInstalled(settings: ClaudeSettings): boolean
   - Return false if settings.hooks is undefined/null
   - Iterate through all HOOK_EVENTS
   - For each event, check if any hook command contains VIBE_TERM_HOOK_SCRIPT
   - Return true on first match, false if none found

5. Helper function createHookConfig(event: string): HookConfig
   - Create config object with hooks array containing single command hook
   - For tool events (PreToolUse, PostToolUse, PostToolUseFailure), add matcher: '*'
   - Command is VIBE_TERM_HOOK_SCRIPT

6. Export function mergeHooks(settings: ClaudeSettings): ClaudeSettings
   - Create shallow copy of settings
   - Create shallow copy of settings.hooks (or empty object if undefined)
   - For each event in HOOK_EVENTS:
     - Get existing array for event (or empty array)
     - Create vibe-term hook config
     - Append vibe-term config to existing array
   - Return merged settings

TypeScript pattern:
- Use 'as const' for HOOK_EVENTS array for type safety
- Import with .js extension for ESM compatibility
  </action>
  <verify>
Run: `npx tsc --noEmit`
Should compile without errors.
Manually verify exports: VIBE_TERM_HOOK_SCRIPT, HOOK_EVENTS, isVibeTermInstalled, mergeHooks
  </verify>
  <done>
hookMerger.ts exists with all required functions.
TypeScript compiles cleanly.
Exports are available for setup command to import.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. src/services/hookMerger.ts exports:
   - VIBE_TERM_HOOK_SCRIPT constant
   - HOOK_EVENTS array (11 events)
   - isVibeTermInstalled function
   - mergeHooks function
3. File follows ESM patterns (.js imports)
</verification>

<success_criteria>
- hookMerger.ts created with detection and merge logic
- TypeScript compilation passes
- All 11 hook events defined
- Tool events get matcher: '*' in their config
</success_criteria>

<output>
After completion, create `.planning/phases/13-cli-router-setup/13-01-SUMMARY.md`
</output>
