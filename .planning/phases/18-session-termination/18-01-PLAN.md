---
phase: 18-session-termination
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/services/paneSessionManager.ts
  - src/services/hookStateService.ts
autonomous: true

must_haves:
  truths:
    - "killSessionPane function terminates tmux pane by ID"
    - "deleteSessionState function removes session JSON file"
    - "Functions handle errors gracefully without throwing"
  artifacts:
    - path: "src/services/paneSessionManager.ts"
      provides: "killSessionPane export"
      exports: ["killSessionPane"]
    - path: "src/services/hookStateService.ts"
      provides: "deleteSessionState export"
      exports: ["deleteSessionState"]
  key_links:
    - from: "src/services/paneSessionManager.ts"
      to: "tmux kill-pane"
      via: "execAsync"
      pattern: "tmux kill-pane"
    - from: "src/services/hookStateService.ts"
      to: "fs.unlink"
      via: "unlinkSync"
      pattern: "unlinkSync"
---

<objective>
Add service functions for session termination: killSessionPane (terminates tmux pane) and deleteSessionState (removes session state file).

Purpose: These service functions are the foundation for the kill feature. They handle the actual cleanup work (pane termination, file removal) that the UI layer will orchestrate.

Output: Two new exported functions ready for use by the kill execution logic.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/18-session-termination/18-RESEARCH.md

@src/services/paneSessionManager.ts
@src/services/hookStateService.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add killSessionPane function to paneSessionManager</name>
  <files>src/services/paneSessionManager.ts</files>
  <action>
Add a new exported function `killSessionPane(sessionId: string): Promise<void>` that:

1. Gets the pane ID using existing `getSessionPane(sessionId)`
2. If no pane found, return early (nothing to kill)
3. Executes `tmux kill-pane -t ${paneId}` to terminate the pane completely
4. Clears the tmux environment variable mapping using existing pattern: `tmux set-environment -u CLAUDE_PANE_${envKey}`
5. Wraps all operations in try/catch - failures should be silent (pane may already be gone)

Use `kill-pane` NOT `respawn-pane` - kill-pane fully removes the pane, respawn-pane just restarts it.

Reference the existing `cleanupSessionPane` function for the pattern, but use `kill-pane` instead of `respawn-pane`.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Function is exported: `grep "export async function killSessionPane" src/services/paneSessionManager.ts`
  </verify>
  <done>
killSessionPane function exists, is exported, uses tmux kill-pane command, and handles errors gracefully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add deleteSessionState function to hookStateService</name>
  <files>src/services/hookStateService.ts</files>
  <action>
Add a new exported function `deleteSessionState(cwd: string): void` that:

1. Uses existing `findStateByPath(cwd)` to find the matching session state
2. If no state found, return early (nothing to delete)
3. Constructs the file path: `path.join(STATE_DIR, ${state.sessionId}.json)`
4. Uses `fs.unlinkSync(statePath)` to delete the file (sync is fine, fast operation)
5. Wraps in try/catch - file may already be deleted or inaccessible

Note: STATE_DIR is already defined as `path.join(os.homedir(), '.claude-hud', 'sessions')` - use the existing constant.

The function takes `cwd` (project path) as input because that's what we have from the Session object, and findStateByPath already handles the mapping.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Function is exported: `grep "export function deleteSessionState" src/services/hookStateService.ts`
  </verify>
  <done>
deleteSessionState function exists, is exported, uses findStateByPath for lookup, removes JSON file, and handles errors gracefully.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `npx tsc --noEmit`
2. Both functions are exported:
   - `grep "killSessionPane" src/services/paneSessionManager.ts`
   - `grep "deleteSessionState" src/services/hookStateService.ts`
3. No runtime errors: `npm run build`
</verification>

<success_criteria>
- killSessionPane is exported from paneSessionManager.ts
- deleteSessionState is exported from hookStateService.ts
- TypeScript compiles successfully
- Build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/18-session-termination/18-01-SUMMARY.md`
</output>
