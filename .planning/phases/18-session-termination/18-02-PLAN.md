---
phase: 18-session-termination
plan: 02
type: execute
wave: 2
depends_on: ["18-01"]
files_modified:
  - src/app.tsx
  - src/components/HudStrip.tsx
autonomous: false

must_haves:
  truths:
    - "User presses 'x' key and sees confirmation prompt with session name"
    - "User presses 'y' and session tab disappears from HUD strip"
    - "User presses 'n' or Escape and returns to normal mode"
    - "Tmux pane is terminated when kill confirmed"
    - "Session state file is removed when kill confirmed"
    - "Killing last session shows empty HUD strip without crash"
    - "External sessions show error message instead of kill prompt"
  artifacts:
    - path: "src/app.tsx"
      provides: "killMode state, key handlers, kill execution"
      contains: "killMode"
    - path: "src/components/HudStrip.tsx"
      provides: "Kill confirmation prompt UI"
      contains: "showKillPrompt"
  key_links:
    - from: "src/app.tsx"
      to: "killSessionPane"
      via: "import and call"
      pattern: "killSessionPane"
    - from: "src/app.tsx"
      to: "deleteSessionState"
      via: "import and call"
      pattern: "deleteSessionState"
    - from: "src/app.tsx"
      to: "src/components/HudStrip.tsx"
      via: "killMode prop"
      pattern: "killMode="
---

<objective>
Implement the complete kill session feature: killMode state, key handlers, UI confirmation prompt, and kill execution with full cleanup.

Purpose: This is the user-facing feature that allows terminating Claude sessions from the HUD. Requires confirmation for safety, handles edge cases (external sessions, last session), and performs complete cleanup (pane + state file + store).

Output: Working kill feature matching requirements KILL-01 through KILL-06.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/18-session-termination/18-RESEARCH.md
@.planning/phases/18-session-termination/18-01-SUMMARY.md

@src/app.tsx
@src/components/HudStrip.tsx
@src/stores/appStore.ts
@src/stores/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add killMode state and key handlers to app.tsx</name>
  <files>src/app.tsx</files>
  <action>
1. Add imports at the top:
   ```typescript
   import { killSessionPane } from './services/paneSessionManager.js';
   import { deleteSessionState } from './services/hookStateService.js';
   ```

2. Add state variables after spawnMode state (around line 36):
   ```typescript
   // Kill mode state for terminating sessions
   const [killMode, setKillMode] = useState<'none' | 'confirming'>('none');
   const [killTargetSession, setKillTargetSession] = useState<Session | null>(null);
   ```
   Note: Import Session type from './stores/types.js' if not already imported.

3. Add killMode handler in useInput AFTER quitMode handler (around line 126), following the same priority pattern:
   ```typescript
   // Handle kill confirmation keys
   if (killMode === 'confirming') {
     if (input === 'y' || input === 'Y') {
       // Execute kill
       if (killTargetSession) {
         // 1. Kill tmux pane
         killSessionPane(killTargetSession.id)
           .then(() => {
             // 2. Delete session state file
             deleteSessionState(killTargetSession.projectPath);
             // 3. Update store (removes from list, clamps selectedIndex)
             useAppStore.getState().removeSession(killTargetSession.id);
           })
           .catch((err) => {
             useAppStore.getState().setError(`Kill failed: ${err.message}`);
             setTimeout(() => {
               useAppStore.getState().setError(null);
             }, 5000);
           });
       }
       setKillMode('none');
       setKillTargetSession(null);
     } else if (key.escape || input === 'n' || input === 'N') {
       setKillMode('none');
       setKillTargetSession(null);
     }
     return;
   }
   ```

4. Modify the existing 'x' key handler (around line 391). Currently it dismisses errors. Change to:
   ```typescript
   // x to kill selected session (or dismiss error if shown)
   if (input === 'x') {
     if (error) {
       useAppStore.getState().setError(null);
       return;
     }
     // Initiate kill if sessions exist
     if (sessions.length > 0) {
       const session = sessions[selectedIndex];
       // Block killing external sessions
       if (session.isExternal) {
         useAppStore.getState().setError('Cannot kill external session');
         setTimeout(() => {
           useAppStore.getState().setError(null);
         }, 3000);
         return;
       }
       setKillTargetSession(session);
       setKillMode('confirming');
     }
     return;
   }
   ```

5. Update the HudStrip component props (around line 430):
   ```typescript
   <HudStrip
     showHelp={showHelp}
     error={error}
     quitMode={quitMode}
     isConfirmingExit={isConfirmingExit}
     spawnMode={spawnMode}
     spawnInput={spawnInput}
     showMkdirPrompt={showMkdirPrompt}
     mkdirPath={mkdirPath}
     completionCount={completions.length}
     hudFocused={hudFocused}
     hasSessions={sessions.length > 0}
     killMode={killMode}
     killTargetSession={killTargetSession}
   />
   ```
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
killMode state exists: `grep "killMode" src/app.tsx`
  </verify>
  <done>
app.tsx has killMode state, handles 'x' key to initiate kill (blocks external sessions), handles 'y'/'n' for confirmation, executes full cleanup on confirm.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add kill confirmation prompt to HudStrip</name>
  <files>src/components/HudStrip.tsx</files>
  <action>
1. Update the HudStripProps interface to add:
   ```typescript
   killMode?: 'none' | 'confirming';
   killTargetSession?: { projectName: string } | null;
   ```

2. Update the function parameters to include:
   ```typescript
   killMode = 'none',
   killTargetSession = null,
   ```

3. Add showKillPrompt to the priority chain (AFTER showSpawnPrompt, BEFORE showQuitPrompt):
   ```typescript
   const showMkdir = showMkdirPrompt;
   const showSpawnPrompt = !showMkdir && spawnMode;
   const showKillPrompt = !showMkdir && !showSpawnPrompt && killMode === 'confirming';
   const showQuitPrompt = !showMkdir && !showSpawnPrompt && !showKillPrompt && quitMode === 'confirming';
   const showExitConfirm = !showMkdir && !showSpawnPrompt && !showKillPrompt && !showQuitPrompt && isConfirmingExit;
   const showHelpText = !showMkdir && !showSpawnPrompt && !showKillPrompt && !showQuitPrompt && !showExitConfirm && showHelp;
   const showError = !showMkdir && !showSpawnPrompt && !showKillPrompt && !showQuitPrompt && !showExitConfirm && !showHelpText && error;
   ```

4. Update showHints to include killMode check:
   ```typescript
   const showHints = hudFocused && hasSessions && !showMkdir && !showSpawnPrompt && !showKillPrompt && !showQuitPrompt && !showExitConfirm && !showHelpText && !showError;
   ```

5. Add the kill confirmation JSX (after spawn prompt, before quit prompt):
   ```tsx
   {/* Kill confirmation prompt */}
   {showKillPrompt && (
     <Text>
       <Text color="red">Kill </Text>
       <Text bold>{killTargetSession?.projectName || 'session'}</Text>
       <Text color="red">? </Text>
       <Text bold color="green">[y]</Text>
       <Text>es / </Text>
       <Text bold color="red">[n]</Text>
       <Text>o</Text>
     </Text>
   )}
   ```

6. Update the hints line to include 'x: kill':
   ```tsx
   {showHints && (
     <Text dimColor>
       ←/→: nav | Enter: switch | n: new | x: kill | q: quit | ?: help
     </Text>
   )}
   ```
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Kill prompt exists: `grep "showKillPrompt" src/components/HudStrip.tsx`
  </verify>
  <done>
HudStrip shows kill confirmation prompt with session name when killMode is 'confirming', and hints include 'x: kill'.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete kill session feature (KILL-01 through KILL-06)</what-built>
  <how-to-verify>
1. Start vibe-term: `npm run dev` or `npx vibe-term`
2. Spawn at least 2 Claude sessions using 'n' key
3. Test KILL-01 and KILL-02: Press 'x' on a selected tab
   - Should see: "Kill [project-name]? [y]es / [n]o"
4. Test cancel: Press 'n' or Escape
   - Should return to normal HUD view
5. Test KILL-03 and KILL-04: Press 'x' then 'y' to confirm
   - Tab should immediately disappear from HUD strip
   - Verify pane is gone: `tmux list-panes -a`
6. Test KILL-05: Check state file is removed
   - List files: `ls ~/.claude-hud/sessions/`
   - Killed session's JSON should be gone
7. Test KILL-06: Kill remaining session(s) until HUD is empty
   - Should show empty state without crashing
8. Test external session blocking (if you have external Claude sessions):
   - Should show error "Cannot kill external session"
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues found</resume-signal>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. Build succeeds: `npm run build`
3. All requirements met:
   - KILL-01: 'x' key initiates kill
   - KILL-02: Confirmation prompt shown
   - KILL-03: tmux pane terminated
   - KILL-04: Tab removed from HUD
   - KILL-05: State file cleaned up
   - KILL-06: Can kill last session
</verification>

<success_criteria>
- 'x' key shows kill confirmation prompt with session name
- 'y' confirms and executes kill (pane + state + store)
- 'n'/Escape cancels without action
- External sessions show error instead of prompt
- Killing last session leaves empty HUD (no crash)
- Human verification confirms all KILL-* requirements pass
</success_criteria>

<output>
After completion, create `.planning/phases/18-session-termination/18-02-SUMMARY.md`
</output>
