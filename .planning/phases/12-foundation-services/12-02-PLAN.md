---
phase: 12-foundation-services
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/services/settingsService.ts
autonomous: true

must_haves:
  truths:
    - "Global Claude settings.json can be read, returning empty object if not found"
    - "Global Claude settings.json can be written with pretty-printed JSON"
    - "Backup is created before writing with human-readable timestamp"
    - "Backup filename format is settings.json.vibe-term-backup.YYYY-MM-DD_HHmmss"
    - "Invalid JSON in settings.json throws a descriptive error"
  artifacts:
    - path: "src/services/settingsService.ts"
      provides: "Claude settings.json read/write/backup operations"
      exports: ["ClaudeSettings", "HookConfig", "readClaudeSettings", "writeClaudeSettings", "backupSettings", "settingsFileExists", "getSettingsPath"]
  key_links:
    - from: "src/services/settingsService.ts"
      to: "fs/promises"
      via: "import"
      pattern: "import.*from 'fs/promises'"
    - from: "src/services/settingsService.ts"
      to: "~/.claude/settings.json"
      via: "CLAUDE_SETTINGS_PATH constant"
      pattern: "join.*\\.claude.*settings\\.json"
---

<objective>
Create settings service for reading, writing, and backing up Claude settings.json files.

Purpose: The setup and fix commands need to modify ~/.claude/settings.json to install hooks. This service provides safe read/write operations with automatic backup support, enabling idempotent hook installation without data loss.

Output:
- src/services/settingsService.ts - Complete settings management service
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-foundation-services/12-RESEARCH.md
@src/services/hookStateService.ts (existing service pattern reference)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create settingsService with read/write/backup functionality</name>
  <files>src/services/settingsService.ts</files>
  <action>
1. Create src/services/settingsService.ts with these imports:
   ```typescript
   import { readFile, writeFile, copyFile, access, constants } from 'fs/promises';
   import { join } from 'path';
   import { homedir } from 'os';
   ```

2. Define constants:
   ```typescript
   const CLAUDE_DIR = join(homedir(), '.claude');
   const CLAUDE_SETTINGS_PATH = join(CLAUDE_DIR, 'settings.json');
   ```

3. Export TypeScript interfaces:
   ```typescript
   export interface ClaudeSettings {
     env?: Record<string, string>;
     attribution?: Record<string, string>;
     hooks?: Record<string, HookConfig[]>;
     [key: string]: unknown;
   }

   export interface HookConfig {
     matcher?: string;
     hooks: Array<{
       type: string;
       command: string;
     }>;
   }
   ```

4. Implement and export these functions:

   **readClaudeSettings():**
   - Read CLAUDE_SETTINGS_PATH
   - Parse JSON and return ClaudeSettings
   - If file not found (ENOENT), return empty object {}
   - If JSON parse fails, throw descriptive error: "Invalid JSON in settings.json: {parse error}"

   **writeClaudeSettings(settings, options?):**
   - options.backup defaults to true
   - If backup is true and file exists, call backupSettings() first
   - Stringify settings with JSON.stringify(settings, null, 2)
   - Write to CLAUDE_SETTINGS_PATH
   - Return backup path if backup was created, null otherwise

   **backupSettings():**
   - Create timestamp with formatTimestamp(new Date())
   - Backup path: `${CLAUDE_SETTINGS_PATH}.vibe-term-backup.${timestamp}`
   - Copy original to backup path
   - Return backup path

   **settingsFileExists():**
   - Use access() with constants.F_OK
   - Return true if accessible, false if ENOENT

   **getSettingsPath():**
   - Return CLAUDE_SETTINGS_PATH

   **formatTimestamp(date):** (private helper)
   - Format: YYYY-MM-DD_HHmmss (human readable, filesystem safe)
   - Example: 2026-01-30_143052
   - Use padStart for single digits

5. Error handling pattern:
   ```typescript
   try {
     const content = await readFile(path, 'utf-8');
     return JSON.parse(content) as ClaudeSettings;
   } catch (error) {
     if ((error as NodeJS.ErrnoException).code === 'ENOENT') {
       return {};
     }
     throw new Error(`Failed to read settings: ${(error as Error).message}`);
   }
   ```

IMPORTANT: Use `.js` extension in any imports for ESM compatibility (though this file has no local imports).
  </action>
  <verify>
1. File exists at src/services/settingsService.ts
2. TypeScript compiles: `npm run typecheck`
3. Build succeeds: `npm run build`
4. Exports are correct:
   ```bash
   # After build, check exports exist
   grep -E "^export (function|interface|const)" src/services/settingsService.ts
   ```
  </verify>
  <done>
- src/services/settingsService.ts exists
- Exports: ClaudeSettings, HookConfig, readClaudeSettings, writeClaudeSettings, backupSettings, settingsFileExists, getSettingsPath
- readClaudeSettings returns {} for missing file
- writeClaudeSettings creates backup before write (when file exists)
- Backup filename format: settings.json.vibe-term-backup.YYYY-MM-DD_HHmmss
- TypeScript compilation passes
- Build succeeds
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. TypeScript compilation passes:
   ```bash
   npm run typecheck
   ```

2. Build succeeds:
   ```bash
   npm run build
   ```

3. File structure correct:
   ```bash
   ls src/services/settingsService.ts
   ```

4. Exports present (verify with grep):
   ```bash
   grep -c "export" src/services/settingsService.ts
   # Should show multiple exports
   ```
</verification>

<success_criteria>
- settingsService.ts created with all required exports
- ClaudeSettings and HookConfig interfaces defined
- readClaudeSettings handles missing file (returns {}) and invalid JSON (throws)
- writeClaudeSettings creates backup before modification
- Backup files use human-readable timestamp format
- TypeScript compilation passes
- Build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/12-foundation-services/12-02-SUMMARY.md`
</output>
